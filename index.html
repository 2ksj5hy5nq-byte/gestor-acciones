<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<!-- FUENTE FINTECH -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ICONOS -->
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* === ESTILOS EXISTENTES (SIN TOCAR) === */
:root{
  --bg:#0b1220;
  --card:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --accent:#3b82f6;
}
body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  padding:16px;
}
h2,h3{margin:0 0 10px 0}
.section-title{display:flex;align-items:center;gap:8px}
input,button,select{
  width:100%;padding:11px;margin:6px 0;border-radius:12px;
  border:1px solid var(--border);background:#020617;color:var(--text)
}
button{border:none;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb);color:white}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#022c22}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:16px;margin-bottom:18px
}
.box{
  background:#020617;border:1px solid var(--border);
  border-radius:14px;padding:14px;margin-bottom:14px
}
.money{font-variant-numeric:tabular-nums}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
</style>
</head>

<body>

<h2 class="section-title">
  <i class="fa-solid fa-chart-line"></i>
  Gestor de Acciones
</h2>

<!-- === NUEVO: IMPORTADOR CSV === -->
<div class="card">
  <h3 class="section-title">
    <i class="fa-solid fa-file-csv"></i> Importar operaciones (CSV)
  </h3>
  <input type="file" accept=".csv" onchange="importarCSV(this)">
  <div class="small">Compatible con CSV de DEGIRO</div>
</div>

<!-- === RESTO DE TU APP (SIN TOCAR) === -->
<!-- TODO EL CONTENIDO QUE YA TENÍAS SIGUE IGUAL -->

<script>
/* === TU CÓDIGO EXISTENTE (SIN MODIFICAR) === */
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
function guardarEstado(){ localStorage.setItem("ops",JSON.stringify(operaciones)); }

/* =====================================================
   === NUEVO BLOQUE: IMPORTACIÓN CSV (AÑADIDO) ===
===================================================== */

function importarCSV(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => procesarCSV(e.target.result);
  reader.readAsText(file);
}

function procesarCSV(texto){
  const lineas = texto.split("\n").slice(1);
  const movimientos = [];

  lineas.forEach(l=>{
    if(!l.trim()) return;
    const c = l.split(",");

    const fecha = convertirFecha(c[0]);
    const accion = c[2];
    const cantidad = Math.abs(parseInt(c[6]));
    const precio = parseFloat(c[7].replace('"','').replace(',','.'));
    const total = parseFloat(c[14].replace('"','').replace(',','.'));
    const tipo = total < 0 ? "COMPRA" : "VENTA";

    movimientos.push({accion,fecha,cantidad,precio,total,tipo});
  });

  agruparMovimientos(movimientos);
}

function convertirFecha(f){
  const [d,m,y] = f.split("-");
  return `${y}-${m}-${d}`;
}

function agruparMovimientos(movs){
  const compras = movs.filter(m=>m.tipo==="COMPRA");
  const ventas  = movs.filter(m=>m.tipo==="VENTA");

  compras.forEach(c=>{
    const v = ventas.find(x =>
      x.accion===c.accion && x.cantidad===c.cantidad
    );
    if(!v) return;

    operaciones.push({
      id:crypto.randomUUID(),
      accion:c.accion,
      cantidad:c.cantidad,
      precioCompra:Math.abs(c.total)/c.cantidad,
      fechaCompra:c.fecha,
      precioVenta:v.total/v.cantidad,
      fechaVenta:v.fecha,
      abierta:false
    });

    ventas.splice(ventas.indexOf(v),1);
  });

  guardarEstado();
  location.reload();
}
</script>

</body>
</html>
