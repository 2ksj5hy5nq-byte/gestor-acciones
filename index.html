<!-- ====== IMPORTAR CSV DEGIRO ====== -->
<div class="card">
  <h3 class="section-title">
    <i class="fa-solid fa-file-import"></i> Importar CSV DEGIRO
  </h3>
  <input type="file" accept=".csv" onchange="importarCSV(this)">
</div>

<script>
/* ===============================
   IMPORTADOR CSV DEGIRO
================================ */

function importarCSV(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e => procesarCSV(e.target.result);
  reader.readAsText(file, "UTF-8");
}

function procesarCSV(texto){
  const lineas = texto.split("\n").slice(1); // quitar cabecera
  const compras = [];
  const ventas = [];

  lineas.forEach(l => {
    if(!l.trim()) return;

    const c = l.split(",");

    const fecha = convertirFecha(c[0]);
    const accion = c[2]?.trim();
    const numero = Number(c[6].replace('"','').replace(',','.'));
    const precio = Number(c[7].replace('"','').replace(',','.'));
    const totalEUR = Number(c[14].replace('"','').replace(',','.'));

    if(!accion || !numero || !fecha) return;

    const op = {
      accion,
      fecha,
      cantidad: Math.abs(numero),
      precio,
      total: Math.abs(totalEUR)
    };

    if(numero > 0){
      compras.push(op);
    } else {
      ventas.push(op);
    }
  });

  emparejarOperaciones(compras, ventas);
}

function emparejarOperaciones(compras, ventas){
  compras.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
  ventas.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));

  compras.forEach(compra=>{
    const venta = ventas.find(v =>
      v.accion === compra.accion &&
      v.cantidad === compra.cantidad &&
      new Date(v.fecha) > new Date(compra.fecha)
    );

    if(!venta) return;

    operaciones.push({
      id: crypto.randomUUID(),
      accion: compra.accion,
      cantidad: compra.cantidad,
      precioCompra: compra.total / compra.cantidad,
      fechaCompra: compra.fecha,
      precioVenta: venta.total / venta.cantidad,
      fechaVenta: venta.fecha,
      abierta: false
    });

    ventas.splice(ventas.indexOf(venta),1);
  });

  guardarEstado();
  render();
  alert("CSV importado correctamente ✔");
}

function convertirFecha(f){
  // DEGIRO: DD-MM-YYYY → YYYY-MM-DD
  const [d,m,y] = f.split("-");
  return `${y}-${m}-${d}`;
}
</script>
