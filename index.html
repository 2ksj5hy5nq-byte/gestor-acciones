<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Acciones</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f172a;
  color: white;
  padding: 16px;
}

h1,h2 { margin-top: 20px; }

input, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border-radius: 8px;
  border: none;
}

button {
  background: #22c55e;
  font-weight: bold;
}

.card {
  background: #020617;
  padding: 12px;
  border-radius: 10px;
  margin-top: 10px;
}

.small { font-size: 13px; opacity: .85; }
.green { color:#22c55e }
.red { color:#ef4444 }
hr { border:0;border-top:1px solid #334155;margin:8px 0 }
</style>
</head>

<body>

<h1>ğŸ“ˆ Gestor de Acciones</h1>

<div class="card">
<h2>Nueva compra</h2>
<input id="accion" placeholder="AcciÃ³n">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<label class="small">Fecha compra</label>
<input id="fechaCompra" type="date">
<button onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h2>ğŸ“… Filtro fechas (compra)</h2>
<input type="date" id="desde">
<input type="date" id="hasta">
<button onclick="render()">Aplicar filtro</button>
</div>

<div class="card">
<button onclick="deshacer()">â†©ï¸ Deshacer</button>
<button onclick="exportarCSV()">ğŸ“¤ Exportar Excel</button>
<button onclick="compartir()">ğŸ“² WhatsApp / Mail</button>
<button onclick="backup()">ğŸ’¾ Backup</button>
<input type="file" onchange="restaurar(event)">
</div>

<h2>ğŸ“‚ Operaciones abiertas</h2>
<div id="abiertas"></div>

<h2>ğŸ“ Cerradas por mes de venta</h2>
<div id="cerradas"></div>

<div class="card">
<h2>ğŸ“Š Resumen</h2>
<p>Total general: <strong id="total"></strong></p>
<p>Capital invertido: <strong id="capital"></strong></p>
<h3>Resumen anual</h3>
<div id="anual"></div>
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let historial = JSON.parse(localStorage.getItem("hist")) || [];

function guardar() {
  localStorage.setItem("ops", JSON.stringify(operaciones));
  localStorage.setItem("hist", JSON.stringify(historial));
  render();
}

function hoy() {
  return new Date().toISOString().slice(0,10);
}

function guardarCompra() {
  if (!accion.value || !cantidad.value || !precio.value) {
    alert("Datos incompletos");
    return;
  }

  historial.push(JSON.stringify(operaciones));

  operaciones.push({
    accion: accion.value.toUpperCase(),
    cantidad: +cantidad.value,
    compra: +precio.value,
    fechaCompra: fechaCompra.value || hoy(),
    abierta: true
  });

  accion.value = cantidad.value = precio.value = "";
  fechaCompra.value = "";

  guardar();
}

function cerrar(i, pv, fv) {
  if (!pv) {
    alert("Precio de venta obligatorio");
    return;
  }

  historial.push(JSON.stringify(operaciones));

  operaciones[i].venta = pv;
  operaciones[i].fechaVenta = fv || hoy();
  operaciones[i].abierta = false;

  guardar();
}

function deshacer() {
  if (!historial.length) return alert("Nada que deshacer");
  operaciones = JSON.parse(historial.pop());
  guardar();
}

function render() {
  abiertas.innerHTML = "";
  cerradas.innerHTML = "";
  anual.innerHTML = "";

  let total = 0;
  let capital = 0;
  let meses = {};
  let aÃ±os = {};

  const d = desde.value;
  const h = hasta.value;

  operaciones.forEach((o,i)=>{
    if (d && o.fechaCompra < d) return;
    if (h && o.fechaCompra > h) return;

    if (o.abierta) {
      capital += o.cantidad * o.compra;

      abiertas.innerHTML += `
      <div class="card">
        <strong>${o.accion}</strong><br>
        ${o.cantidad} Ã— ${o.compra} â‚¬<br>
        <span class="small">Compra: ${o.fechaCompra}</span>
        <hr>
        <input type="number" id="v${i}" placeholder="Precio venta">
        <label class="small">Fecha venta</label>
        <input type="date" id="f${i}">
        <button onclick="cerrar(${i},
          +document.getElementById('v${i}').value,
          document.getElementById('f${i}').value
        )">Cerrar</button>
      </div>`;
    } else {
      const r = (o.venta - o.compra) * o.cantidad;
      total += r;

      const mes = o.fechaVenta.slice(0,7);
      const aÃ±o = o.fechaVenta.slice(0,4);

      meses[mes] ??= [];
      meses[mes].push({...o,r});
      aÃ±os[aÃ±o] = (aÃ±os[aÃ±o] || 0) + r;
    }
  });

  for (const m in meses) {
    const sm = meses[m].reduce((a,b)=>a+b.r,0);
    cerradas.innerHTML += `
    <div class="card">
      <strong>${m}</strong>
      ${meses[m].map(o=>`
        <div class="small">
        ${o.accion} â†’ 
        <span class="${o.r>=0?'green':'red'}">
        ${o.r.toFixed(2)} â‚¬
        </span>
        </div>`).join("")}
      <hr>Total mes: ${sm.toFixed(2)} â‚¬
    </div>`;
  }

  for (const a in aÃ±os) {
    anual.innerHTML += `<div>${a}: <strong>${aÃ±os[a].toFixed(2)} â‚¬</strong></div>`;
  }

  total.textContent = total.toFixed(2) + " â‚¬";
  capital.textContent = capital.toFixed(2) + " â‚¬";
}

function exportarCSV() {
  let csv = "Accion,Cantidad,Compra,FechaCompra,Venta,FechaVenta,Resultado\n";
  operaciones.forEach(o=>{
    if(!o.abierta){
      csv += `${o.accion},${o.cantidad},${o.compra},${o.fechaCompra},${o.venta},${o.fechaVenta},${(o.venta-o.compra)*o.cantidad}\n`;
    }
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "acciones.csv";
  a.click();
}

function compartir() {
  const texto = encodeURIComponent(
    "Resultado total: " + document.getElementById("total").textContent
  );
  window.open(`https://wa.me/?text=${texto}`);
}

function backup() {
  const blob = new Blob([JSON.stringify(operaciones)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "backup_acciones.json";
  a.click();
}

function restaurar(e) {
  const r = new FileReader();
  r.onload = ()=>{ operaciones = JSON.parse(r.result); guardar(); };
  r.readAsText(e.target.files[0]);
}

render();
</script>

</body>
</html>
