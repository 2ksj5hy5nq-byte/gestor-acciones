<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* ====== ESTILO PROFESIONAL (NO TOCADO) ====== */
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;
  --green:#22c55e;--red:#ef4444;--accent:#3b82f6;
}
body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);font-family:Inter,system-ui;padding:16px
}
h2,h3{margin:0 0 10px}
.section-title{display:flex;gap:8px;align-items:center}
input,button,select{
  width:100%;padding:11px;margin:6px 0;border-radius:12px;
  border:1px solid var(--border);background:#020617;color:var(--text)
}
button{border:none;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:16px;margin-bottom:18px}
.box{background:#020617;border:1px solid var(--border);
  border-radius:14px;padding:14px;margin-bottom:14px}
.money{font-variant-numeric:tabular-nums}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
</style>
</head>

<body>

<h2 class="section-title">
<i class="fa-solid fa-chart-line"></i> Gestor de Acciones
</h2>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-upload"></i> Importar DEGIRO</h3>
<button class="btn-secondary">
<i class="fa-solid fa-file-csv"></i> Seleccionar CSV DEGIRO
</button>
<input type="file" accept=".csv" onchange="importarDegiro(this)">
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-plus"></i> Nueva compra manual</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-folder-open"></i> Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-folder-closed"></i> Operaciones cerradas</h3>
<div id="cerradas"></div>
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];

function guardarEstado(){
  localStorage.setItem("ops",JSON.stringify(operaciones));
}

/* ========= IMPORTAR DEGIRO (CSV ESPAÑOL) ========= */
function importarDegiro(input){
  const file=input.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split("\n");
    const header=lines[0].split(";");

    const idx={
      fecha:header.indexOf("Fecha"),
      tipo:header.indexOf("Tipo"),
      accion:header.indexOf("Producto"),
      cantidad:header.indexOf("Cantidad"),
      precio:header.indexOf("Precio")
    };

    const comprasFIFO={};

    for(let i=1;i<lines.length;i++){
      const row=lines[i].split(";");
      if(row.length<5) continue;

      const fecha=row[idx.fecha];
      const tipo=row[idx.tipo];
      const accion=row[idx.accion];
      const cantidad=Math.abs(Number(row[idx.cantidad]));
      const precio=Number(row[idx.precio].replace(",","."));      

      if(tipo==="Compra"){
        if(!comprasFIFO[accion]) comprasFIFO[accion]=[];
        comprasFIFO[accion].push({
          fechaCompra:fecha,
          cantidad,
          precioCompra:precio
        });
      }

      if(tipo==="Venta"){
        let restante=cantidad;
        while(restante>0 && comprasFIFO[accion]?.length){
          const compra=comprasFIFO[accion][0];
          const usar=Math.min(restante,compra.cantidad);

          operaciones.push({
            id:crypto.randomUUID(),
            accion,
            cantidad:usar,
            precioCompra:compra.precioCompra,
            fechaCompra:compra.fechaCompra,
            precioVenta:precio,
            fechaVenta:fecha,
            abierta:false
          });

          compra.cantidad-=usar;
          restante-=usar;
          if(compra.cantidad===0) comprasFIFO[accion].shift();
        }
      }
    }

    guardarEstado();
    render();
    alert("Importación DEGIRO completada");
  };
  reader.readAsText(file,"ISO-8859-1");
}

/* ===== MANUAL ===== */
function guardarCompra(){
  const a=accion.value,c=+cantidad.value,p=+precio.value,f=fechaCompra.value;
  if(!a||!c||!p||!f) return alert("Completa todo");
  operaciones.push({
    id:crypto.randomUUID(),
    accion:a,cantidad:c,precioCompra:p,fechaCompra:f,abierta:true
  });
  guardarEstado();render();
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
}

/* ===== RENDER ===== */
function render(){
  abiertas.innerHTML="";cerradas.innerHTML="";
  operaciones.forEach(o=>{
    const c=o.cantidad*o.precioCompra;
    if(o.abierta){
      abiertas.innerHTML+=`
      <div class="box">
        <strong>${o.accion}</strong><br>
        ${o.fechaCompra}<br>
        <span class="money">${o.cantidad} × ${o.precioCompra} € = ${c.toFixed(2)} €</span>
      </div>`;
    }else{
      const v=o.cantidad*o.precioVenta;
      const r=v-c;
      cerradas.innerHTML+=`
      <div class="box">
        <strong>${o.accion}</strong><br>
        <span class="money">${c.toFixed(2)} € → ${v.toFixed(2)} €</span><br>
        <span class="${r>=0?'green':'red'}">${r.toFixed(2)} €</span>
      </div>`;
    }
  });
}
render();
</script>

</body>
</html>
