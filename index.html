<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;
  --green:#22c55e;--red:#ef4444;--accent:#3b82f6;
}
body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  padding:16px;
}
h2,h3{margin:0 0 10px 0}
.section-title{display:flex;align-items:center;gap:8px}
input,button,select{
  width:100%;padding:11px;margin:6px 0;border-radius:12px;
  border:1px solid var(--border);background:#020617;color:var(--text);
}
button{border:none;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:16px;margin-bottom:18px;
}
.box{
  background:#020617;border:1px solid var(--border);
  border-radius:14px;padding:14px;margin-bottom:14px;
}
.money{font-variant-numeric:tabular-nums;font-family:Inter,monospace}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
.icon{cursor:pointer;margin-left:8px}
.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.kpi{background:#020617;border:1px solid var(--border);border-radius:14px;padding:14px}
.kpi-title{font-size:13px;color:var(--muted)}
.kpi-value{font-size:22px;font-weight:700}
</style>
</head>

<body>

<h2 class="section-title"><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card">
  <div class="dashboard">
    <div class="kpi">
      <div class="kpi-title">Mes en curso</div>
      <div id="kpiMes" class="kpi-value money">0 €</div>
    </div>
    <div class="kpi">
      <div class="kpi-title">Año en curso</div>
      <div id="kpiAnio" class="kpi-value money">0 €</div>
    </div>
  </div>
</div>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.0001" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3>Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3>Operaciones cerradas</h3>

<select id="filtroMes" onchange="render()">
<option value="">Todos los meses</option>
</select>
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">

<div id="totalMes"></div>
<div id="cerradas"></div>

<button class="btn-secondary" onclick="deshacer()">Deshacer borrado</button>
<button class="btn-secondary" onclick="exportarCSV()">Exportar Excel</button>
<button class="btn-secondary" onclick="backup()">Backup</button>
<button class="btn-secondary" onclick="csvInput.click()">Importar operaciones</button>
<input type="file" id="csvInput" accept=".csv" hidden onchange="importarCSV(this)">
<input type="file" onchange="restaurar(this)">
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let papelera=null;

function guardarEstado(){
  localStorage.setItem("ops",JSON.stringify(operaciones));
}

function parseNumeroEU(v){
  if(!v) return NaN;
  return parseFloat(v.replace(/"/g,"").replace(/\./g,"").replace(",","."));
}

function guardarCompra(){
  if(!accion.value||!cantidad.value||!precio.value||!fechaCompra.value)return;
  operaciones.push({
    id:crypto.randomUUID(),
    accion:accion.value.trim(),
    cantidad:+cantidad.value,
    precioCompra:+precio.value,
    fechaCompra:fechaCompra.value,
    abierta:true
  });
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
  guardarEstado();render();
}

function importarCSV(input){
  const file=input.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    const filas=e.target.result.split(/\r?\n/).filter(l=>l.trim());
    if(filas.length<2) return;

    const headers=filas[0].split(",");
    const idxAccion=headers.indexOf("Producto");
    const idxFecha=headers.indexOf("Fecha");
    const idxNumero=headers.indexOf("Número");
    const idxPrecio=headers.indexOf("Precio");

    const compras={},ventas={};

    filas.slice(1).forEach(f=>{
      const c=f.split(",");
      const accion=c[idxAccion]?.trim();
      const fecha=c[idxFecha]?.split("-").reverse().join("-");
      const numero=parseInt(c[idxNumero]);
      const cantidad=Math.abs(numero);
      const precio=parseNumeroEU(c[idxPrecio]);

      if(!accion || !cantidad || isNaN(precio)) return;

      const obj={accion,cantidad,precio,fecha};

      if(numero<0){
        (ventas[accion]=ventas[accion]||[]).push(obj);
      }else{
        (compras[accion]=compras[accion]||[]).push(obj);
      }
    });

    Object.keys(compras).forEach(a=>{
      let v=ventas[a]||[];
      compras[a].forEach(c=>{
        if(v.length){
          const s=v.shift();
          operaciones.push({
            id:crypto.randomUUID(),
            accion:a,
            cantidad:c.cantidad,
            precioCompra:c.precio,
            fechaCompra:c.fecha,
            precioVenta:s.precio,
            fechaVenta:s.fecha,
            abierta:false
          });
        }else{
          operaciones.push({
            id:crypto.randomUUID(),
            accion:a,
            cantidad:c.cantidad,
            precioCompra:c.precio,
            fechaCompra:c.fecha,
            abierta:true
          });
        }
      });
    });

    guardarEstado();
    render();
  };
  reader.readAsText(file);
}

function editar(id){
  const o=operaciones.find(x=>x.id===id);
  const pv=parseFloat(prompt("Precio venta",o.precioVenta));
  const fv=prompt("Fecha venta",o.fechaVenta);
  if(!pv||!fv)return;
  o.precioVenta=pv;o.fechaVenta=fv;
  guardarEstado();render();
}

function borrar(id){
  papelera=operaciones.find(o=>o.id===id);
  operaciones=operaciones.filter(o=>o.id!==id);
  guardarEstado();render();
}
function deshacer(){
  if(!papelera)return;
  operaciones.push(papelera);
  papelera=null;
  guardarEstado();render();
}

function render(){
  renderAbiertas();
  renderCerradas();
  renderFiltroMes();
  renderDashboard();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="box">
      <b>${o.accion}</b><br>
      Compra ${o.fechaCompra} — ${o.cantidad} × ${o.precioCompra.toFixed(4)}
    </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";let total=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    if(filtroMes.value && !o.fechaVenta.startsWith(filtroMes.value))return;
    if(desde.value && o.fechaVenta<desde.value)return;
    if(hasta.value && o.fechaVenta>hasta.value)return;

    const r=o.cantidad*(o.precioVenta-o.precioCompra);
    total+=r;

    cerradas.innerHTML+=`
    <div class="box">
      <b>${o.accion}</b><br>
      Compra ${o.fechaCompra} — ${o.cantidad} × ${o.precioCompra.toFixed(4)}<br>
      Venta ${o.fechaVenta} — ${o.cantidad} × ${o.precioVenta.toFixed(4)}<br>
      <div class="${r>=0?'green':'red'}">${r.toFixed(2)} €</div>
      <i class="fa-solid fa-pen icon" onclick="editar('${o.id}')"></i>
      <i class="fa-solid fa-trash icon" onclick="borrar('${o.id}')"></i>
    </div>`;
  });
  totalMes.innerHTML=`TOTAL FILTRADO: ${total.toFixed(2)} €`;
}

function renderFiltroMes(){
  const meses=[...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta.slice(0,7)))];
  filtroMes.innerHTML='<option value="">Todos</option>';
  meses.forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

function renderDashboard(){
  const hoy=new Date();
  const mes=hoy.toISOString().slice(0,7);
  const anio=hoy.getFullYear().toString();
  let m=0,a=0;

  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=o.cantidad*(o.precioVenta-o.precioCompra);
    if(o.fechaVenta.startsWith(mes)) m+=r;
    if(o.fechaVenta.startsWith(anio)) a+=r;
  });

  kpiMes.textContent=m.toFixed(2)+" €";
  kpiAnio.textContent=a.toFixed(2)+" €";
}

function exportarCSV(){
  let csv="Acción,Fecha compra,Cantidad,Precio compra,Fecha venta,Precio venta,Resultado\n";
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    csv+=`${o.accion},${o.fechaCompra},${o.cantidad},${o.precioCompra},${o.fechaVenta},${o.precioVenta},${(o.cantidad*(o.precioVenta-o.precioCompra)).toFixed(2)}\n`;
  });
  const b=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="operaciones.csv";
  a.click();
}

function backup(){
  const b=new Blob([JSON.stringify(operaciones)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="backup.json";
  a.click();
}

function restaurar(i){
  const r=new FileReader();
  r.onload=e=>{
    operaciones=JSON.parse(e.target.result);
    guardarEstado();render();
  };
  r.readAsText(i.files[0]);
}

render();
</script>

</body>
</html>
