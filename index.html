<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  padding:15px;
}
input,button{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:8px;
  border:none;
}
button{
  background:#22c55e;
  font-weight:bold;
}
.card{
  background:#020617;
  padding:12px;
  border-radius:10px;
  margin-bottom:15px;
}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.small{font-size:13px;opacity:.8}
hr{border:0;border-top:1px solid #334155;margin:10px 0}
</style>
</head>

<body>

<h2>ğŸ“ˆ Gestor de Acciones</h2>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="AcciÃ³n">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3>ğŸ” Buscador</h3>
<input placeholder="Buscar acciÃ³n..." oninput="buscar(this.value)">
</div>

<div class="card">
<h3>ğŸ“… Filtro fechas (venta)</h3>
<input id="desde" type="date">
<input id="hasta" type="date">
<button onclick="aplicarFiltro()">Aplicar filtro</button>
</div>

<div class="card">
<button onclick="deshacer()">â†©ï¸ Deshacer</button>
<button onclick="exportar()">ğŸ“¤ Exportar Excel</button>
<button onclick="compartir()">ğŸ“± WhatsApp / Mail</button>
<button onclick="backup()">ğŸ’¾ Backup</button>
<input type="file" onchange="restaurar(this)">
</div>

<div class="card">
<h3>ğŸ“‚ Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3>ğŸ“ Cerradas por mes de venta</h3>
<div id="cerradas"></div>
</div>

<div class="card">
<h3>ğŸ“Š Resumen</h3>
<div id="resumen"></div>
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let historial = [];
let textoFiltro = "";
let filtroFechas = null;

const â‚¬ = n => `${n.toFixed(2)} â‚¬`;

function guardarEstado(){
  localStorage.setItem("ops", JSON.stringify(operaciones));
}

function guardarCompra(){
  const a = accion.value.trim();
  const c = +cantidad.value;
  const p = +precio.value;
  const f = fechaCompra.value;

  if(!a||!c||!p||!f){alert("Datos incompletos");return;}

  historial.push(JSON.stringify(operaciones));

  operaciones.push({
    id: crypto.randomUUID(),
    accion:a,
    cantidad:c,
    precioCompra:p,
    fechaCompra:f,
    abierta:true,
    precioVenta:null,
    fechaVenta:null
  });

  guardarEstado(); render();
}

function cerrarOperacion(id){
  const pv = prompt("Precio venta");
  const fv = prompt("Fecha venta (YYYY-MM-DD)");
  if(!pv||!fv)return;

  historial.push(JSON.stringify(operaciones));

  const o = operaciones.find(x=>x.id===id);
  o.precioVenta=+pv;
  o.fechaVenta=fv;
  o.abierta=false;

  guardarEstado(); render();
}

function buscar(t){textoFiltro=t.toLowerCase();render();}
function aplicarFiltro(){
  filtroFechas={desde:desde.value,hasta:hasta.value};
  render();
}

function deshacer(){
  if(!historial.length)return;
  operaciones=JSON.parse(historial.pop());
  guardarEstado();render();
}

function exportar(){
  let csv="AcciÃ³n,Cantidad,Compra,FechaCompra,Venta,FechaVenta\n";
  operaciones.forEach(o=>{
    csv+=`${o.accion},${o.cantidad},${o.precioCompra},${o.fechaCompra},${o.precioVenta||""},${o.fechaVenta||""}\n`;
  });
  const blob=new Blob([csv]);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="acciones.csv";
  a.click();
}

function compartir(){
  const txt=operaciones.map(o=>`${o.accion} ${o.abierta?"ABIERTA":"CERRADA"}`).join("\n");
  navigator.share({text:txt});
}

function backup(){
  const blob=new Blob([JSON.stringify(operaciones)]);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backup.json";
  a.click();
}

function restaurar(i){
  const f=i.files[0];
  const r=new FileReader();
  r.onload=()=>{operaciones=JSON.parse(r.result);guardarEstado();render();}
  r.readAsText(f);
}

function filtradas(){
  return operaciones.filter(o=>{
    if(textoFiltro && !o.accion.toLowerCase().includes(textoFiltro))return false;
    if(filtroFechas && o.fechaVenta){
      if(o.fechaVenta<filtroFechas.desde||o.fechaVenta>filtroFechas.hasta)return false;
    }
    return true;
  });
}

function render(){
  renderAbiertas();renderCerradas();renderResumen();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  filtradas().filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="row">
      <div>
        <b>${o.accion}</b><br>
        <span class="small">${o.cantidad} Ã— ${â‚¬(o.precioCompra)}</span><br>
        <span class="small">Compra ${o.fechaCompra}</span>
      </div>
      <button onclick="cerrarOperacion('${o.id}')">Cerrar</button>
    </div><hr>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";
  const g={};
  filtradas().filter(o=>!o.abierta).forEach(o=>{
    const m=o.fechaVenta.slice(0,7);
    g[m]=g[m]||{};
    g[m][o.accion]=g[m][o.accion]||[];
    g[m][o.accion].push(o);
  });

  Object.entries(g).forEach(([mes,acciones])=>{
    let totalMes=0;
    let html=`<b>${mes}</b><br>`;
    Object.entries(acciones).forEach(([a,ops])=>{
      let t=0;
      ops.forEach(o=>t+=(o.precioVenta-o.precioCompra)*o.cantidad);
      totalMes+=t;
      html+=`â–¶ ${a} â†’ ${â‚¬(t)}<br>`;
    });
    html+=`<b>Total mes: ${â‚¬(totalMes)}</b><hr>`;
    cerradas.innerHTML+=html;
  });
}

function renderResumen(){
  let inv=0,rec=0;
  operaciones.forEach(o=>{
    inv+=o.cantidad*o.precioCompra;
    if(!o.abierta)rec+=o.cantidad*o.precioVenta;
  });
  resumen.innerHTML=`
  Capital invertido: ${â‚¬(inv)}<br>
  Capital recuperado: ${â‚¬(rec)}<br>
  Resultado: ${â‚¬(rec-inv)}
  `;
}

render();
</script>
</body>
</html>
