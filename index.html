<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Acciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  background:#0f172a;
  color:white;
  font-family:-apple-system, BlinkMacSystemFont, sans-serif;
  padding:15px;
}
input, button {
  width:100%;
  margin:6px 0;
  padding:10px;
  border-radius:8px;
  border:none;
}
button {
  background:#22c55e;
  color:black;
  font-weight:600;
}
.section {
  margin-top:25px;
  padding:15px;
  background:#020617;
  border-radius:12px;
}
hr { border:0; height:1px; background:#1e293b }
</style>
</head>

<body>

<h2>ğŸ“ˆ Gestor de Acciones</h2>

<div class="section">
  <input id="accion" placeholder="AcciÃ³n">
  <input id="cantidad" type="number" placeholder="Cantidad">
  <input id="precio" type="number" step="0.01" placeholder="Precio compra">
  <input id="fechaCompra" type="date">
  <button type="button" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="section">
  <input placeholder="Buscar acciÃ³n" oninput="buscar(this.value)">
</div>

<div class="section">
  <h3>ğŸ“‚ Operaciones abiertas</h3>
  <div id="abiertas"></div>
</div>

<div class="section">
  <h3>ğŸ“¦ Cerradas por mes</h3>
  <div id="cerradas"></div>
</div>

<div class="section">
  <h3>ğŸ“Š Resumen</h3>
  <div id="resumen"></div>
</div>

<div class="section">
  <button onclick="exportar()">ğŸ“¤ Exportar Excel</button>
  <button onclick="deshacer()">â†©ï¸ Deshacer</button>
</div>

<script>
// ================= ESTADO =================
let ops = JSON.parse(localStorage.getItem("ops")) || [];
let undo = [];
let filtro = "";

// ================= UTIL =================
const â‚¬ = n => n.toFixed(2) + " â‚¬";
const save = () => localStorage.setItem("ops", JSON.stringify(ops));

// ID compatible con iPhone
function generarId(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2);
}

// ================= BUSCAR =================
function buscar(v){
  filtro = v.toLowerCase();
  render();
}

// ================= GUARDAR COMPRA =================
function guardarCompra(){
  const accion = document.getElementById("accion").value.trim();
  const cantidad = Number(document.getElementById("cantidad").value);
  const precio = Number(document.getElementById("precio").value);
  const fecha = document.getElementById("fechaCompra").value;

  if(!accion || !cantidad || !precio || !fecha){
    alert("Faltan datos");
    return;
  }

  undo.push(JSON.stringify(ops));

  ops.push({
    id: generarId(),
    accion,
    cantidad,
    compra: precio,
    fechaCompra: fecha,
    venta: null,
    fechaVenta: null
  });

  document.getElementById("accion").value = "";
  document.getElementById("cantidad").value = "";
  document.getElementById("precio").value = "";
  document.getElementById("fechaCompra").value = "";

  save();
  render();
}

// ================= CERRAR =================
function cerrar(id){
  const pv = document.getElementById("pv_"+id).value;
  const fv = document.getElementById("fv_"+id).value;

  if(!pv || !fv){
    alert("Falta precio o fecha de venta");
    return;
  }

  undo.push(JSON.stringify(ops));

  const o = ops.find(x => x.id === id);
  o.venta = Number(pv);
  o.fechaVenta = fv;

  save();
  render();
}

// ================= RENDER =================
function render(){
  document.getElementById("abiertas").innerHTML = "";
  document.getElementById("cerradas").innerHTML = "";

  ops.filter(o => !o.venta && o.accion.toLowerCase().includes(filtro))
     .forEach(o => {
      document.getElementById("abiertas").innerHTML += `
        <div>
          <b>${o.accion}</b> Â· ${o.cantidad} Ã— ${o.compra}
          <input id="pv_${o.id}" placeholder="Precio venta">
          <input id="fv_${o.id}" type="date">
          <button onclick="cerrar('${o.id}')">Cerrar</button>
          <hr>
        </div>`;
     });

  const meses = {};
  ops.filter(o => o.venta).forEach(o => {
    const mes = o.fechaVenta.slice(0,7);
    if(!meses[mes]) meses[mes] = [];
    meses[mes].push(o);
  });

  for(const mes in meses){
    let totalMes = 0;
    document.getElementById("cerradas").innerHTML += `<h4>${mes}</h4>`;
    meses[mes].forEach(o => {
      const r = (o.venta - o.compra) * o.cantidad;
      totalMes += r;
      document.getElementById("cerradas").innerHTML += `${o.accion}: ${â‚¬(r)}<br>`;
    });
    document.getElementById("cerradas").innerHTML += `<b>Total mes: ${â‚¬(totalMes)}</b><hr>`;
  }

  let invertido = 0, recuperado = 0;
  ops.forEach(o => {
    invertido += o.cantidad * o.compra;
    if(o.venta) recuperado += o.cantidad * o.venta;
  });

  document.getElementById("resumen").innerHTML = `
    Invertido: ${â‚¬(invertido)}<br>
    Recuperado: ${â‚¬(recuperado)}<br>
    Resultado: ${â‚¬(recuperado - invertido)}
  `;
}

// ================= EXCEL =================
function exportar(){
  let csv = "AcciÃ³n;Cantidad;Compra;Venta;Fecha compra;Fecha venta\n";
  ops.forEach(o => {
    csv += `${o.accion};${o.cantidad};${o.compra};${o.venta||""};${o.fechaCompra};${o.fechaVenta||""}\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "acciones.csv";
  a.click();
}

// ================= DESHACER =================
function deshacer(){
  if(!undo.length) return;
  ops = JSON.parse(undo.pop());
  save();
  render();
}

render();
</script>

</body>
</html>
