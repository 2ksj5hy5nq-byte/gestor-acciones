<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<!-- FUENTE FINTECH -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- ICONOS -->
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#0b1220;
  --card:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --accent:#3b82f6;
}

body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  padding:16px;
}

h2,h3{margin:0 0 10px 0}

.section-title{
  display:flex;
  align-items:center;
  gap:8px;
}

input,button,select{
  width:100%;
  padding:11px;
  margin:6px 0;
  border-radius:12px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
  font-family:inherit;
}

input::placeholder{color:var(--muted)}

button{
  border:none;
  font-weight:600;
  cursor:pointer;
}

.btn-primary{
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  color:white;
}

.btn-success{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#022c22;
}

.btn-secondary{
  background:#020617;
  border:1px solid var(--border);
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.35);
}

.box{
  background:#020617;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.small{font-size:13px;color:var(--muted)}

.money{
  font-variant-numeric:tabular-nums;
  font-family:Inter,monospace;
}

.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}

.icon{
  cursor:pointer;
  font-size:18px;
  padding:6px;
  border-radius:8px;
}

.icon.edit{color:#38bdf8}
.icon.delete{color:#ef4444}
.icon:hover{background:#020617}

.range{display:flex;gap:8px}

.modal{
  background:#020617;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  margin-top:10px;
}

hr{
  border:none;
  border-top:1px solid var(--border);
  margin:10px 0;
}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.kpi{
  background:#020617;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}

.kpi-title{
  font-size:13px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:6px;
}

.kpi-value{
  font-size:22px;
  font-weight:700;
  margin-top:6px;
}
</style>
</head>

<body>

<h2 class="section-title">
  <i class="fa-solid fa-chart-line"></i>
  Gestor de Acciones
</h2>

<!-- DASHBOARD -->
<div class="card">
  <div class="dashboard">
    <div class="kpi">
      <div class="kpi-title">
        <i class="fa-solid fa-calendar-days"></i> Mes en curso
      </div>
      <div id="kpiMes" class="kpi-value money">0 €</div>
    </div>
    <div class="kpi">
      <div class="kpi-title">
        <i class="fa-solid fa-chart-pie"></i> Año en curso
      </div>
      <div id="kpiAnio" class="kpi-value money">0 €</div>
    </div>
  </div>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-plus"></i> Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">
  <i class="fa-solid fa-floppy-disk"></i> Guardar compra
</button>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-folder-open"></i> Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-folder-closed"></i> Operaciones cerradas</h3>

<select id="filtroMes" onchange="render()">
<option value="">Todos los meses</option>
</select>

<div class="range">
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">
</div>

<div id="totalMes"></div>
<div id="cerradas"></div>

<button class="btn-secondary" onclick="deshacer()">
  <i class="fa-solid fa-rotate-left"></i> Deshacer borrado
</button>
<button class="btn-secondary" onclick="exportarCSV()">
  <i class="fa-solid fa-file-excel"></i> Exportar Excel
</button>
<button class="btn-secondary" onclick="backup()">
  <i class="fa-solid fa-cloud-arrow-down"></i> Backup
</button>
<input type="file" onchange="restaurar(this)">
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let papelera=null;
let cerrarId=null;

function guardarEstado(){
  localStorage.setItem("ops",JSON.stringify(operaciones));
}

function guardarCompra(){
  const a=accion.value.trim();
  const c=Number(cantidad.value);
  const p=Number(precio.value);
  const f=fechaCompra.value;
  if(!a||!c||!p||!f){alert("Completa todos los datos");return;}
  operaciones.push({
    id:crypto.randomUUID(),
    accion:a,
    cantidad:c,
    precioCompra:p,
    fechaCompra:f,
    abierta:true
  });
  guardarEstado();
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
  render();
}

function mostrarCerrar(id){cerrarId=id;render();}
function confirmarCerrar(){
  const pv=Number(document.getElementById("precioVenta").value);
  const fv=document.getElementById("fechaVenta").value;
  if(!pv||!fv){alert("Completa precio y fecha");return;}
  const o=operaciones.find(x=>x.id===cerrarId);
  o.precioVenta=pv;
  o.fechaVenta=fv;
  o.abierta=false;
  cerrarId=null;
  guardarEstado();
  render();
}
function cancelarCerrar(){cerrarId=null;render();}

function editar(id){
  const o=operaciones.find(x=>x.id===id);
  const pv=Number(prompt("Precio venta",o.precioVenta));
  const fv=prompt("Fecha venta",o.fechaVenta);
  if(!pv||!fv)return;
  o.precioVenta=pv;o.fechaVenta=fv;
  guardarEstado();render();
}

function borrar(id){
  papelera=operaciones.find(o=>o.id===id);
  operaciones=operaciones.filter(o=>o.id!==id);
  guardarEstado();render();
}
function deshacer(){
  if(!papelera)return;
  operaciones.push(papelera);
  papelera=null;
  guardarEstado();render();
}

function render(){
  renderAbiertas();
  renderCerradas();
  renderFiltroMes();
  renderDashboard();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      ${o.fechaCompra}<br>
      <span class="money">${o.cantidad} × ${o.precioCompra} € = ${(o.cantidad*o.precioCompra).toFixed(2)} €</span>
      <button class="btn-success" onclick="mostrarCerrar('${o.id}')">
        <i class="fa-solid fa-check"></i> Cerrar
      </button>
      ${cerrarId===o.id?`
      <div class="modal">
        <input id="precioVenta" type="number" step="0.01" placeholder="Precio venta">
        <input id="fechaVenta" type="date">
        <button class="btn-success" onclick="confirmarCerrar()">Confirmar</button>
        <button class="btn-secondary" onclick="cancelarCerrar()">Cancelar</button>
      </div>`:""}
    </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";let total=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    if(filtroMes.value && !o.fechaVenta.startsWith(filtroMes.value))return;
    if(desde.value && o.fechaVenta<desde.value)return;
    if(hasta.value && o.fechaVenta>hasta.value)return;

    const c=o.cantidad*o.precioCompra;
    const v=o.cantidad*o.precioVenta;
    const r=v-c; total+=r;

    cerradas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      ${o.fechaCompra}<br>
      <span class="money">${o.cantidad} × ${o.precioCompra} € = ${c.toFixed(2)} €</span>
      <hr>
      ${o.fechaVenta}<br>
      <span class="money">${o.cantidad} × ${o.precioVenta} € = ${v.toFixed(2)} €</span>
      <div class="money ${r>=0?'green':'red'}">${r>=0?'+':''}${r.toFixed(2)} €</div>
      <i class="fa-solid fa-pen icon edit" onclick="editar('${o.id}')"></i>
      <i class="fa-solid fa-trash icon delete" onclick="borrar('${o.id}')"></i>
    </div>`;
  });
  totalMes.innerHTML=`<strong class="money">TOTAL FILTRADO: ${total.toFixed(2)} €</strong>`;
}

function renderFiltroMes(){
  const meses=[...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta.slice(0,7)))];
  filtroMes.innerHTML='<option value="">Todos los meses</option>';
  meses.forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

function renderDashboard(){
  const hoy=new Date();
  const mes=hoy.toISOString().slice(0,7);
  const anio=hoy.getFullYear().toString();
  let mesTotal=0, anioTotal=0;

  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=(o.cantidad*o.precioVenta)-(o.cantidad*o.precioCompra);
    if(o.fechaVenta.startsWith(mes)) mesTotal+=r;
    if(o.fechaVenta.startsWith(anio)) anioTotal+=r;
  });

  kpiMes.textContent=`${mesTotal.toFixed(2)} €`;
  kpiMes.className=`kpi-value money ${mesTotal>=0?'green':'red'}`;
  kpiAnio.textContent=`${anioTotal.toFixed(2)} €`;
  kpiAnio.className=`kpi-value money ${anioTotal>=0?'green':'red'}`;
}

function exportarCSV(){
  let csv="Acción,Fecha compra,Cantidad,Precio compra,Importe compra,Fecha venta,Precio venta,Importe venta,Resultado\n";
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const compra=o.cantidad*o.precioCompra;
    const venta=o.cantidad*o.precioVenta;
    const res=venta-compra;
    csv+=`${o.accion},${o.fechaCompra},${o.cantidad},${o.precioCompra},${compra.toFixed(2)},${o.fechaVenta},${o.precioVenta},${venta.toFixed(2)},${res.toFixed(2)}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="operaciones.csv";
  a.click();
}

function backup(){
  const hoy=new Date().toISOString().slice(0,10);
  const b=new Blob([JSON.stringify(operaciones)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download=`backup_${hoy}.json`;
  a.click();
}

function restaurar(i){
  const r=new FileReader();
  r.onload=e=>{
    operaciones=JSON.parse(e.target.result);
    guardarEstado();
    render();
  };
  r.readAsText(i.files[0]);
}

render();
</script>

</body>
</html>
