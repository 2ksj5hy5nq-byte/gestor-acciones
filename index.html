<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Acciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
  padding:14px
}
h2,h3,h4{margin-top:20px}
input,button{
  width:100%;
  padding:8px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:6px;
  font-weight:bold
}
.green{background:#22c55e;color:black}
.gray{background:#334155;color:white}
.blue{background:#2563eb;color:white}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px
}
th,td{
  border-bottom:1px solid #334155;
  padding:6px;
  text-align:center;
  font-size:14px
}
.gain{color:#22c55e}
.loss{color:#ef4444}
.filtro{
  background:#020617;
  padding:10px;
  border-radius:8px;
  margin-top:10px
}
</style>
</head>

<body>

<h2>ðŸ“ˆ Gestor de Acciones</h2>

<!-- NUEVA COMPRA -->
<h3>âž• Nueva compra</h3>
<input id="accion" placeholder="AcciÃ³n">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precioCompra" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="green" onclick="guardarCompra()">Guardar compra</button>

<!-- ABIERTAS -->
<h3>ðŸ“‚ Operaciones abiertas</h3>
<table>
<thead>
<tr>
<th>AcciÃ³n</th><th>Cant.</th><th>Compra</th><th>Fecha</th><th>Cerrar</th>
</tr>
</thead>
<tbody id="tablaAbiertas"></tbody>
</table>

<!-- FILTROS -->
<h3>ðŸ”Ž Filtros (ventas)</h3>
<div class="filtro">
  Buscar acciÃ³n:
  <input id="buscar" placeholder="Ej: AAPL, BBVA" oninput="pintarHistorico()">
  Desde:
  <input id="desde" type="date">
  Hasta:
  <input id="hasta" type="date">
  <button class="gray" onclick="pintarHistorico()">Aplicar filtros</button>
</div>

<!-- EXPORTAR -->
<h3>ðŸ“¤ Exportar</h3>
<button class="blue" onclick="exportarCSV()">ðŸ“Š Exportar a Excel / Compartir</button>

<!-- HISTÃ“RICO -->
<h3>ðŸ“† HistÃ³rico por meses</h3>
<div id="historico"></div>

<script>
let abiertas = JSON.parse(localStorage.getItem("abiertas")) || [];
let historico = JSON.parse(localStorage.getItem("historico")) || {};

// ===== COMPRAS =====
function guardarCompra(){
  if(!accion.value||!cantidad.value||!precioCompra.value||!fechaCompra.value){
    alert("Completa todos los campos"); return;
  }
  abiertas.push({
    accion: accion.value.toUpperCase(),
    cantidad:+cantidad.value,
    compra:+precioCompra.value,
    fechaCompra:fechaCompra.value
  });
  guardar();
  accion.value=cantidad.value=precioCompra.value=fechaCompra.value="";
  pintarAbiertas();
}

function cerrarOperacion(i){
  const pv = document.getElementById("pv_"+i).value;
  const fv = document.getElementById("fv_"+i).value;
  if(!pv||!fv){alert("Precio y fecha de venta");return;}

  const o = abiertas.splice(i,1)[0];
  o.venta = +pv;
  o.fechaVenta = fv;
  o.totalCompra = o.cantidad * o.compra;
  o.totalVenta = o.cantidad * o.venta;
  o.resultado = o.totalVenta - o.totalCompra;

  const mes = fv.slice(0,7);
  if(!historico[mes]) historico[mes]=[];
  historico[mes].push(o);

  guardar();
  pintarAbiertas();
  pintarHistorico();
}

// ===== PINTAR =====
function pintarAbiertas(){
  tablaAbiertas.innerHTML="";
  abiertas.forEach((o,i)=>{
    tablaAbiertas.innerHTML+=`
      <tr>
        <td>${o.accion}</td>
        <td>${o.cantidad}</td>
        <td>${o.compra}</td>
        <td>${o.fechaCompra}</td>
        <td>
          <input id="pv_${i}" type="number" step="0.01" placeholder="Venta">
          <input id="fv_${i}" type="date">
          <button class="gray" onclick="cerrarOperacion(${i})">Cerrar</button>
        </td>
      </tr>`;
  });
}

function pintarHistorico(){
  const d = desde.value;
  const h = hasta.value;
  const b = buscar.value.toUpperCase();
  historicoDiv.innerHTML="";

  Object.keys(historico).sort().reverse().forEach(mes=>{
    let totalMes=0;
    let filas="";

    historico[mes]
      .sort((a,b)=>a.fechaVenta.localeCompare(b.fechaVenta))
      .forEach(o=>{
        if(
          (!d||o.fechaVenta>=d) &&
          (!h||o.fechaVenta<=h) &&
          (!b||o.accion.includes(b))
        ){
          totalMes+=o.resultado;
          filas+=`
            <tr>
              <td>${o.accion}</td>
              <td class="${o.resultado>=0?'gain':'loss'}">
                ${o.resultado.toFixed(2)} â‚¬
              </td>
              <td>${o.fechaVenta}</td>
            </tr>`;
        }
      });

    if(filas){
      historicoDiv.innerHTML+=`
        <h4>${mes}</h4>
        <table>
          <tr><th>AcciÃ³n</th><th>Resultado</th><th>Fecha</th></tr>
          ${filas}
        </table>
        <strong class="${totalMes>=0?'gain':'loss'}">
          Total mes: ${totalMes.toFixed(2)} â‚¬
        </strong>`;
    }
  });
}

// ===== EXPORTAR CSV =====
function exportarCSV(){
  let csv = "AcciÃ³n;Cantidad;Precio Compra;Precio Venta;Fecha Compra;Fecha Venta;Resultado\n";

  Object.values(historico).flat().forEach(o=>{
    csv += `${o.accion};${o.cantidad};${o.compra};${o.venta};${o.fechaCompra};${o.fechaVenta};${o.resultado.toFixed(2)}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const file = new File([blob], "operaciones.csv", { type: "text/csv" });

  // iPhone / Safari â†’ menÃº compartir
  if (navigator.share) {
    navigator.share({
      title: "Operaciones",
      text: "ExportaciÃ³n de operaciones",
      files: [file]
    });
  } else {
    // Descarga normal (PC)
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "operaciones.csv";
    link.click();
  }
}

// ===== STORAGE =====
function guardar(){
  localStorage.setItem("abiertas",JSON.stringify(abiertas));
  localStorage.setItem("historico",JSON.stringify(historico));
}

const tablaAbiertas=document.getElementById("tablaAbiertas");
const historicoDiv=document.getElementById("historico");

pintarAbiertas();
pintarHistorico();
</script>

</body>
</html>
