<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<style>
body{background:#0f172a;color:white;font-family:Arial;padding:15px}
input,button,select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none}
button{background:#22c55e;font-weight:bold}
.card{background:#020617;padding:12px;border-radius:10px;margin-bottom:15px}
.box{border:1px solid #334155;border-radius:8px;padding:10px;margin-bottom:12px}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.small{opacity:.8;font-size:14px}
.green{color:#22c55e;font-weight:bold}
.red{color:#ef4444;font-weight:bold}
.icon{cursor:pointer;margin-left:10px}
.range{display:flex;gap:6px}
.modal{background:#020617;padding:10px;border-radius:8px;margin-top:8px}
hr{opacity:.3}
</style>
</head>

<body>

<h2>ğŸ“ˆ Gestor de Acciones</h2>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="AcciÃ³n">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3>ğŸ“‚ Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3>ğŸ“ Operaciones cerradas</h3>

<select id="filtroMes" onchange="render()">
<option value="">Todos los meses</option>
</select>

<div class="range">
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">
</div>

<div id="totalMes"></div>
<div id="cerradas"></div>

<button onclick="deshacer()">â†©ï¸ Deshacer borrado</button>
<button onclick="exportarCSV()">ğŸ“¤ Exportar Excel</button>
<button onclick="backup()">ğŸ’¾ Backup</button>
<input type="file" onchange="restaurar(this)">
</div>

<div class="card">
<h3>ğŸ“Š Resumen</h3>
<div id="resumen"></div>
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let papelera=null;
let cerrarId=null;

function guardarEstado(){
  localStorage.setItem("ops",JSON.stringify(operaciones));
}

function guardarCompra(){
  const a=accion.value.trim();
  const c=Number(cantidad.value);
  const p=Number(precio.value);
  const f=fechaCompra.value;
  if(!a||!c||!p||!f){alert("Completa todos los datos");return;}
  operaciones.push({
    id:crypto.randomUUID(),
    accion:a,
    cantidad:c,
    precioCompra:p,
    fechaCompra:f,
    abierta:true
  });
  guardarEstado();
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
  render();
}

function mostrarCerrar(id){cerrarId=id;render();}
function confirmarCerrar(){
  const pv=Number(document.getElementById("precioVenta").value);
  const fv=document.getElementById("fechaVenta").value;
  if(!pv||!fv){alert("Completa precio y fecha");return;}
  const o=operaciones.find(x=>x.id===cerrarId);
  o.precioVenta=pv;
  o.fechaVenta=fv;
  o.abierta=false;
  cerrarId=null;
  guardarEstado();
  render();
}
function cancelarCerrar(){cerrarId=null;render();}

function editar(id){
  const o=operaciones.find(x=>x.id===id);
  const pv=Number(prompt("Precio venta",o.precioVenta));
  const fv=prompt("Fecha venta",o.fechaVenta);
  if(!pv||!fv)return;
  o.precioVenta=pv;o.fechaVenta=fv;
  guardarEstado();render();
}

function borrar(id){
  papelera=operaciones.find(o=>o.id===id);
  operaciones=operaciones.filter(o=>o.id!==id);
  guardarEstado();render();
}
function deshacer(){
  if(!papelera)return;
  operaciones.push(papelera);
  papelera=null;
  guardarEstado();render();
}

function render(){
  renderAbiertas();
  renderCerradas();
  renderFiltroMes();
  renderResumen();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="box">
      <div class="row">
        <div>
          <strong>${o.accion}</strong><br>
          ${o.fechaCompra}<br>
          ${o.cantidad} Ã— ${o.precioCompra} â‚¬ = ${(o.cantidad*o.precioCompra).toFixed(2)} â‚¬
        </div>
        <button onclick="mostrarCerrar('${o.id}')">Cerrar</button>
      </div>
      ${cerrarId===o.id?`
      <div class="modal">
        <input id="precioVenta" type="number" step="0.01" placeholder="Precio venta">
        <input id="fechaVenta" type="date">
        <button onclick="confirmarCerrar()">Confirmar</button>
        <button onclick="cancelarCerrar()">Cancelar</button>
      </div>`:""}
    </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";let total=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    if(filtroMes.value && !o.fechaVenta.startsWith(filtroMes.value))return;
    if(desde.value && o.fechaVenta<desde.value)return;
    if(hasta.value && o.fechaVenta>hasta.value)return;

    const c=o.cantidad*o.precioCompra;
    const v=o.cantidad*o.precioVenta;
    const r=v-c; total+=r;

    cerradas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      ${o.fechaCompra}<br>
      ${o.cantidad} Ã— ${o.precioCompra} â‚¬ = ${c.toFixed(2)} â‚¬
      <hr>
      ${o.fechaVenta}<br>
      ${o.cantidad} Ã— ${o.precioVenta} â‚¬ = ${v.toFixed(2)} â‚¬
      <div class="${r>=0?'green':'red'}">${r>=0?'+':''}${r.toFixed(2)} â‚¬</div>
      <span class="icon" onclick="editar('${o.id}')">âœï¸</span>
      <span class="icon" onclick="borrar('${o.id}')">ğŸ—‘</span>
    </div>`;
  });
  totalMes.innerHTML=`<strong>TOTAL FILTRADO: ${total.toFixed(2)} â‚¬</strong>`;
}

function renderFiltroMes(){
  const meses=[...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta.slice(0,7)))];
  filtroMes.innerHTML='<option value="">Todos los meses</option>';
  meses.forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

function renderResumen(){
  const hoy=new Date();
  const mes=hoy.toISOString().slice(0,7);
  const anio=hoy.getFullYear().toString();

  let mesTotal=0, anioTotal=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=(o.cantidad*o.precioVenta)-(o.cantidad*o.precioCompra);
    if(o.fechaVenta.startsWith(mes)) mesTotal+=r;
    if(o.fechaVenta.startsWith(anio)) anioTotal+=r;
  });

  resumen.innerHTML=`
    Mes en curso:
    <span class="${mesTotal>=0?'green':'red'}">${mesTotal.toFixed(2)} â‚¬</span><br>
    AÃ±o en curso:
    <span class="${anioTotal>=0?'green':'red'}">${anioTotal.toFixed(2)} â‚¬</span>
  `;
}

/* ===== EXPORTAR EXCEL (CON RESULTADO POR OPERACIÃ“N) ===== */
function exportarCSV(){
  let csv="AcciÃ³n,Fecha compra,Cantidad,Precio compra,Importe compra,Fecha venta,Precio venta,Importe venta,Resultado\n";

  operaciones
    .filter(o=>!o.abierta)
    .forEach(o=>{
      if(filtroMes.value && !o.fechaVenta.startsWith(filtroMes.value))return;
      if(desde.value && o.fechaVenta<desde.value)return;
      if(hasta.value && o.fechaVenta>hasta.value)return;

      const compra=o.cantidad*o.precioCompra;
      const venta=o.cantidad*o.precioVenta;
      const res=venta-compra;

      csv+=`${o.accion},${o.fechaCompra},${o.cantidad},${o.precioCompra},${compra.toFixed(2)},${o.fechaVenta},${o.precioVenta},${venta.toFixed(2)},${res.toFixed(2)}\n`;
    });

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="operaciones_filtradas.csv";
  a.click();
}

function backup(){
  const b=new Blob([JSON.stringify(operaciones)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="backup.json";
  a.click();
}

function restaurar(i){
  const r=new FileReader();
  r.onload=e=>{
    operaciones=JSON.parse(e.target.result);
    guardarEstado();
    render();
  };
  r.readAsText(i.files[0]);
}

render();
</script>

</body>
</html>
