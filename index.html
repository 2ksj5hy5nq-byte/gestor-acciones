<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#0b1220;
  --card:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --accent:#3b82f6;
}

body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;
  padding:16px;
}

h2,h3{margin:0 0 10px 0}
.section-title{display:flex;align-items:center;gap:8px}

input,button,select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}

button{cursor:pointer;font-weight:600}
.btn-primary{background:#2563eb;color:white}
.btn-secondary{background:#020617;border:1px solid var(--border)}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin-bottom:16px;
}

.box{
  background:#020617;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}

.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
</style>
</head>

<body>

<h2 class="section-title">
<i class="fa-solid fa-chart-line"></i> Gestor de Acciones
</h2>

<div class="card">
<h3><i class="fa-solid fa-file-import"></i> Importar CSV DEGIRO</h3>
<input type="file" accept=".csv" onchange="importarDegiro(this)">
</div>

<div class="card">
<h3><i class="fa-solid fa-plus"></i> Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3><i class="fa-solid fa-folder-open"></i> Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3><i class="fa-solid fa-folder-closed"></i> Operaciones cerradas</h3>
<div id="cerradas"></div>
</div>

<div class="card">
<h3><i class="fa-solid fa-chart-pie"></i> Resumen</h3>
<div id="resumen"></div>
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];

function guardarEstado(){
  localStorage.setItem("ops",JSON.stringify(operaciones));
}

/* ===============================
   IMPORTAR CSV DEGIRO (FIFO)
================================ */
function importarDegiro(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e=>{
    const lineas = e.target.result.split("\n");
    const cabecera = lineas.shift().toLowerCase();

    const compras = [];
    const ventas = [];

    lineas.forEach(l=>{
      const cols = l.split(",");
      if(cols.length < 5) return;

      const texto = l.toLowerCase();
      const accion = cols[0].trim();
      const fecha = cols[1].trim();
      const tipo = texto.includes("venta") ? "venta" : "compra";
      const cantidad = Math.abs(Number(cols[2]));
      const precio = Math.abs(Number(cols[3]));

      const obj = {accion,cantidad,precio,fecha};

      if(tipo==="compra") compras.push(obj);
      else ventas.push(obj);
    });

    ventas.forEach(v=>{
      const i = compras.findIndex(c =>
        c.accion===v.accion &&
        c.cantidad===v.cantidad &&
        c.fecha<=v.fecha
      );

      if(i>-1){
        const c = compras.splice(i,1)[0];
        operaciones.push({
          id:crypto.randomUUID(),
          accion:v.accion,
          cantidad:v.cantidad,
          precioCompra:c.precio,
          fechaCompra:c.fecha,
          precioVenta:v.precio,
          fechaVenta:v.fecha,
          abierta:false
        });
      }
    });

    compras.forEach(c=>{
      operaciones.push({
        id:crypto.randomUUID(),
        accion:c.accion,
        cantidad:c.cantidad,
        precioCompra:c.precio,
        fechaCompra:c.fecha,
        abierta:true
      });
    });

    guardarEstado();
    render();
    alert("Importación DEGIRO completada");
  };
  reader.readAsText(file);
}

/* ===============================
   FUNCIONES EXISTENTES
================================ */
function guardarCompra(){
  if(!accion.value||!cantidad.value||!precio.value||!fechaCompra.value)return;
  operaciones.push({
    id:crypto.randomUUID(),
    accion:accion.value,
    cantidad:Number(cantidad.value),
    precioCompra:Number(precio.value),
    fechaCompra:fechaCompra.value,
    abierta:true
  });
  guardarEstado();
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
  render();
}

function render(){
  renderAbiertas();
  renderCerradas();
  renderResumen();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
      <div class="box">
        <strong>${o.accion}</strong><br>
        ${o.fechaCompra}<br>
        ${o.cantidad} × ${o.precioCompra} €
      </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=(o.cantidad*o.precioVenta)-(o.cantidad*o.precioCompra);
    cerradas.innerHTML+=`
      <div class="box">
        <strong>${o.accion}</strong><br>
        ${o.fechaCompra} → ${o.fechaVenta}<br>
        Resultado:
        <span class="${r>=0?'green':'red'}">${r.toFixed(2)} €</span>
      </div>`;
  });
}

function renderResumen(){
  let total=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    total+=(o.cantidad*o.precioVenta)-(o.cantidad*o.precioCompra);
  });
  resumen.innerHTML=`Resultado total: <strong>${total.toFixed(2)} €</strong>`;
}

render();
</script>

</body>
</html>
