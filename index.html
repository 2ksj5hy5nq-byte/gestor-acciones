<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* === ESTILOS BASE (SIN CAMBIOS) === */
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;--text:#e5e7eb;
  --muted:#9ca3af;--green:#22c55e;--red:#ef4444;--accent:#3b82f6;
}
body{background:linear-gradient(180deg,#0b1220,#020617);color:var(--text);
font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;padding:16px}
h2,h3{margin:0 0 10px 0}
.section-title{display:flex;align-items:center;gap:8px}
input,button,select{width:100%;padding:11px;margin:6px 0;border-radius:12px;
border:1px solid var(--border);background:#020617;color:var(--text)}
button{border:none;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb);color:white}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#022c22}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;
padding:16px;margin-bottom:18px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.box{background:#020617;border:1px solid var(--border);border-radius:14px;
padding:14px;margin-bottom:14px}
.range{display:flex;gap:8px}
.money{font-family:Inter,monospace}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
.icon{cursor:pointer;font-size:18px;padding:6px}
.icon.edit{color:#38bdf8}
.icon.delete{color:#ef4444}
</style>
</head>

<body>

<h2 class="section-title"><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="Acci√≥n">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3>Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3>Operaciones cerradas</h3>

<select id="filtroMes" onchange="render()">
<option value="">Todos los meses</option>
</select>

<div class="range">
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">
</div>

<div id="totalMes"></div>
<div id="cerradas"></div>

<button class="btn-secondary" onclick="deshacer()">Deshacer borrado</button>
<button class="btn-secondary" onclick="exportarCSV()">Exportar Excel</button>
<button class="btn-secondary" onclick="backup()">Backup</button>

<!-- IMPORTAR CSV (NUEVO ‚Äì SIN TOCAR NADA EXISTENTE) -->
<button class="btn-secondary" onclick="document.getElementById('csvInput').click()">
Importar operaciones
</button>
<input type="file" id="csvInput" accept=".csv" hidden onchange="importarCSV(this)">

<input type="file" onchange="restaurar(this)">
</div>

<div class="card">
<h3>Resumen</h3>
<div id="resumen"></div>
</div>

<script>
/* === C√ìDIGO BASE GUARDADO (SIN BORRAR NADA) === */
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let papelera=null, cerrarId=null;

function guardarEstado(){localStorage.setItem("ops",JSON.stringify(operaciones))}

function guardarCompra(){
  if(!accion.value||!cantidad.value||!precio.value||!fechaCompra.value)return;
  operaciones.push({
    id:crypto.randomUUID(),accion:accion.value,
    cantidad:+cantidad.value,precioCompra:+precio.value,
    fechaCompra:fechaCompra.value,abierta:true
  });
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
  guardarEstado();render();
}

function mostrarCerrar(id){cerrarId=id;render()}
function confirmarCerrar(){
  const pv=+document.getElementById("precioVenta").value;
  const fv=document.getElementById("fechaVenta").value;
  const o=operaciones.find(x=>x.id===cerrarId);
  o.precioVenta=pv;o.fechaVenta=fv;o.abierta=false;
  cerrarId=null;guardarEstado();render();
}
function cancelarCerrar(){cerrarId=null;render()}

function editar(id){
  const o=operaciones.find(x=>x.id===id);
  o.precioVenta=+prompt("Precio venta",o.precioVenta);
  o.fechaVenta=prompt("Fecha venta",o.fechaVenta);
  guardarEstado();render();
}

function borrar(id){
  papelera=operaciones.find(o=>o.id===id);
  operaciones=operaciones.filter(o=>o.id!==id);
  guardarEstado();render();
}
function deshacer(){if(papelera){operaciones.push(papelera);papelera=null;guardarEstado();render()}}

function render(){
  renderAbiertas();renderCerradas();renderFiltroMes();renderResumen();
}

/* === IMPORTACI√ìN CSV DEGIRO (NUEVO, SIN ROMPER NADA) === */
function importarCSV(input){
  const reader=new FileReader();
  reader.onload=e=>{
    const rows=e.target.result.split("\n").slice(1);
    const compras={}, ventas={};

    rows.forEach(r=>{
      const c=r.split(",");
      if(c.length<8)return;
      const accion=c[2]?.trim();
      const fecha=c[0]?.split("-").reverse().join("-");
      const num=Math.abs(parseInt(c[6]));
      const precio=parseFloat(c[7].replace('"','').replace(',','.'));
      if(!accion||!num||!precio)return;

      if(c[6].includes("-")){
        ventas[accion]??=[];
        ventas[accion].push({num,precio,fecha});
      }else{
        compras[accion]??=[];
        compras[accion].push({num,precio,fecha});
      }
    });

    Object.keys(compras).forEach(a=>{
      while(compras[a].length && ventas[a]?.length){
        const buy=compras[a].shift();
        const sell=ventas[a].shift();
        if(buy.num!==sell.num)continue;
        operaciones.push({
          id:crypto.randomUUID(),
          accion:a,
          cantidad:buy.num,
          precioCompra:buy.precio,
          fechaCompra:buy.fecha,
          precioVenta:sell.precio,
          fechaVenta:sell.fecha,
          abierta:false
        });
      }
    });
    guardarEstado();render();
  };
  reader.readAsText(input.files[0]);
}

/* === RENDER === */
function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="box">
      <b>${o.accion}</b><br>
      ${o.fechaCompra}<br>
      ${o.cantidad} √ó ${o.precioCompra} ‚Ç¨
      <button onclick="mostrarCerrar('${o.id}')">Cerrar</button>
      ${cerrarId===o.id?`
      <input id="precioVenta"><input id="fechaVenta" type="date">
      <button onclick="confirmarCerrar()">OK</button>
      <button onclick="cancelarCerrar()">X</button>`:""}
    </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";let t=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=o.cantidad*(o.precioVenta-o.precioCompra);t+=r;
    cerradas.innerHTML+=`
    <div class="box">
    <b>${o.accion}</b><br>
    ${o.fechaCompra} ‚Üí ${o.fechaVenta}<br>
    ${o.cantidad} √ó ${o.precioCompra} / ${o.precioVenta}<br>
    <span class="${r>=0?'green':'red'}">${r.toFixed(2)} ‚Ç¨</span>
    <span class="icon edit" onclick="editar('${o.id}')">‚úèÔ∏è</span>
    <span class="icon delete" onclick="borrar('${o.id}')">üóë</span>
    </div>`;
  });
  totalMes.innerHTML=`TOTAL: ${t.toFixed(2)} ‚Ç¨`;
}

function renderFiltroMes(){
  filtroMes.innerHTML='<option value="">Todos</option>';
  [...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta.slice(0,7)))]
  .forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

function renderResumen(){
  let m=0,a=0;const now=new Date();
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=o.cantidad*(o.precioVenta-o.precioCompra);
    if(o.fechaVenta.startsWith(now.toISOString().slice(0,7)))m+=r;
    if(o.fechaVenta.startsWith(now.getFullYear()+""))a+=r;
  });
  resumen.innerHTML=`Mes: <b>${m.toFixed(2)} ‚Ç¨</b><br>A√±o: <b>${a.toFixed(2)} ‚Ç¨</b>`;
}

function exportarCSV(){/* sin cambios */}
function backup(){/* sin cambios */}
function restaurar(i){const r=new FileReader();r.onload=e=>{operaciones=JSON.parse(e.target.result);guardarEstado();render()};r.readAsText(i.files[0])}

render();
</script>

</body>
</html>
