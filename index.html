<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Acciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  background:#0f172a;
  color:white;
  font-family:-apple-system, BlinkMacSystemFont, sans-serif;
  padding:15px;
}
input, button {
  width:100%;
  margin:6px 0;
  padding:10px;
  border-radius:8px;
  border:none;
}
button {
  background:#22c55e;
  color:black;
  font-weight:600;
}
.section {
  margin-top:25px;
  padding:15px;
  background:#020617;
  border-radius:12px;
}
small { color:#94a3b8 }
hr { border:0; height:1px; background:#1e293b }
</style>
</head>

<body>

<h2>ğŸ“ˆ Gestor de Acciones</h2>

<div class="section">
  <input id="accion" placeholder="AcciÃ³n">
  <input id="cantidad" type="number" placeholder="Cantidad">
  <input id="precio" type="number" step="0.01" placeholder="Precio compra">
  <input id="fechaCompra" type="date">
  <button onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="section">
  <input placeholder="Buscar acciÃ³n" oninput="buscar(this.value)">
</div>

<div class="section">
  <h3>ğŸ“‚ Operaciones abiertas</h3>
  <div id="abiertas"></div>
</div>

<div class="section">
  <h3>ğŸ“¦ Cerradas por mes</h3>
  <div id="cerradas"></div>
</div>

<div class="section">
  <h3>ğŸ“Š Resumen</h3>
  <div id="resumen"></div>
</div>

<div class="section">
  <button onclick="exportar()">ğŸ“¤ Exportar Excel</button>
  <button onclick="deshacer()">â†©ï¸ Deshacer</button>
</div>

<script>
// ================= ESTADO =================
let ops = JSON.parse(localStorage.getItem("ops")) || [];
let undo = [];
let filtro = "";

// ================= UTIL =================
const â‚¬ = n => n.toFixed(2)+" â‚¬";
const save = () => localStorage.setItem("ops", JSON.stringify(ops));

// ================= BUSCAR =================
function buscar(v){
  filtro = v.toLowerCase();
  render();
}

// ================= GUARDAR COMPRA =================
function guardarCompra(){
  const a = accion.value.trim();
  const c = +cantidad.value;
  const p = +precio.value;
  const f = fechaCompra.value;
  if(!a||!c||!p||!f) return alert("Faltan datos");

  undo.push(JSON.stringify(ops));

  ops.push({
    id:crypto.randomUUID(),
    accion:a,
    cantidad:c,
    compra:p,
    fechaCompra:f,
    venta:null,
    fechaVenta:null
  });

  save(); render();
}

// ================= CERRAR =================
function cerrar(id){
  const pv = document.getElementById("pv_"+id).value;
  const fv = document.getElementById("fv_"+id).value;
  if(!pv||!fv) return alert("Falta venta o fecha");

  undo.push(JSON.stringify(ops));

  const o = ops.find(x=>x.id===id);
  o.venta=+pv;
  o.fechaVenta=fv;

  save(); render();
}

// ================= RENDER =================
function render(){
  abiertas.innerHTML="";
  cerradas.innerHTML="";

  ops.filter(o=>!o.venta && o.accion.toLowerCase().includes(filtro))
     .forEach(o=>{
      abiertas.innerHTML+=`
      <div>
        <b>${o.accion}</b> ${o.cantidad} x ${o.compra}
        <input id="pv_${o.id}" placeholder="Precio venta">
        <input id="fv_${o.id}" type="date">
        <button onclick="cerrar('${o.id}')">Cerrar</button>
        <hr>
      </div>`;
     });

  const meses={};
  ops.filter(o=>o.venta)
     .forEach(o=>{
      const m=o.fechaVenta.slice(0,7);
      if(!meses[m]) meses[m]=[];
      meses[m].push(o);
     });

  for(const m in meses){
    let t=0;
    cerradas.innerHTML+=`<h4>${m}</h4>`;
    meses[m].forEach(o=>{
      const r=(o.venta-o.compra)*o.cantidad;
      t+=r;
      cerradas.innerHTML+=`${o.accion}: ${â‚¬(r)}<br>`;
    });
    cerradas.innerHTML+=`<b>Total mes: ${â‚¬(t)}</b><hr>`;
  }

  let inv=0, rec=0;
  ops.forEach(o=>{
    inv+=o.cantidad*o.compra;
    if(o.venta) rec+=o.cantidad*o.venta;
  });

  resumen.innerHTML=`
  Invertido: ${â‚¬(inv)}<br>
  Recuperado: ${â‚¬(rec)}<br>
  Resultado: ${â‚¬(rec-inv)}
  `;
}

// ================= EXCEL =================
function exportar(){
  let csv="AcciÃ³n;Cantidad;Compra;Venta;Fecha compra;Fecha venta\n";
  ops.forEach(o=>{
    csv+=`${o.accion};${o.cantidad};${o.compra};${o.venta||""};${o.fechaCompra};${o.fechaVenta||""}\n`;
  });
  const b=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="acciones.csv";
  a.click();
}

// ================= DESHACER =================
function deshacer(){
  if(!undo.length) return;
  ops=JSON.parse(undo.pop());
  save(); render();
}

render();
</script>

</body>
</html>
