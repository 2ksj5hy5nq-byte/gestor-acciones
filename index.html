<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* === ESTILOS ORIGINALES SIN CAMBIOS === */
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;
  --green:#22c55e;--red:#ef4444;--accent:#3b82f6;
}
body{background:linear-gradient(180deg,#0b1220,#020617);color:var(--text);font-family:Inter;padding:16px}
input,button,select{width:100%;padding:11px;margin:6px 0;border-radius:12px;border:1px solid var(--border);background:#020617;color:var(--text)}
button{font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:18px}
.box{background:#020617;border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
.money{font-family:monospace}
</style>
</head>

<body>

<h2><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card">
  <div><b>Mes en curso:</b> <span id="kpiMes">0 €</span></div>
  <div><b>Año en curso:</b> <span id="kpiAnio">0 €</span></div>
</div>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3>Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3>Operaciones cerradas</h3>

<select id="filtroMes" onchange="render()">
<option value="">Todos los meses</option>
</select>

<div>
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">
</div>

<div id="totalMes"></div>
<div id="cerradas"></div>

<button class="btn-secondary" onclick="deshacer()">Deshacer borrado</button>
<button class="btn-secondary" onclick="exportarCSV()">Exportar Excel</button>
<button class="btn-secondary" onclick="backup()">Backup</button>

<!-- ✅ NUEVA FUNCIÓN: IMPORTAR OPERACIONES -->
<button class="btn-secondary">Importar operaciones</button>
<input type="file" accept=".csv" onchange="importarCSV(this)">
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let papelera=null, cerrarId=null;

function guardarEstado(){localStorage.setItem("ops",JSON.stringify(operaciones));}

/* === IMPORTACIÓN CSV DEGIRO === */
function importarCSV(input){
  const file=input.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const rows=e.target.result.split("\n").slice(1);
    const compras={}, ventas={};

    rows.forEach(r=>{
      const c=r.split(",");
      if(c.length<8) return;

      const accion=c[2]?.trim();
      const fecha=c[0]?.split("-").reverse().join("-");
      const num=parseFloat(c[6].replace('"','').replace(',','.'));
      const precio=parseFloat(c[7].replace('"','').replace(',','.'));

      if(!accion||isNaN(num)||isNaN(precio)) return;

      const qty=Math.abs(num);

      if(num>0){
        if(!compras[accion]) compras[accion]=[];
        compras[accion].push({qty,precio,fecha});
      }else{
        if(!ventas[accion]) ventas[accion]=[];
        ventas[accion].push({qty,precio,fecha});
      }
    });

    Object.keys(compras).forEach(a=>{
      while(compras[a]?.length && ventas[a]?.length){
        const buy=compras[a].shift();
        const sell=ventas[a].shift();
        const q=Math.min(buy.qty,sell.qty);

        operaciones.push({
          id:crypto.randomUUID(),
          accion:a,
          cantidad:q,
          precioCompra:buy.precio,
          fechaCompra:buy.fecha,
          precioVenta:sell.precio,
          fechaVenta:sell.fecha,
          abierta:false
        });
      }
    });

    guardarEstado();
    render();
    input.value="";
  };
  reader.readAsText(file);
}

/* === RESTO DEL CÓDIGO ORIGINAL SIN CAMBIOS === */
function guardarCompra(){const a=accion.value,c=+cantidad.value,p=+precio.value,f=fechaCompra.value;
if(!a||!c||!p||!f)return;operaciones.push({id:crypto.randomUUID(),accion:a,cantidad:c,precioCompra:p,fechaCompra:f,abierta:true});
guardarEstado();accion.value=cantidad.value=precio.value=fechaCompra.value="";render();}

function render(){renderAbiertas();renderCerradas();renderFiltroMes();renderDashboard();}

function renderAbiertas(){
abiertas.innerHTML="";
operaciones.filter(o=>o.abierta).forEach(o=>{
abiertas.innerHTML+=`<div class="box">${o.accion} ${o.cantidad} × ${o.precioCompra}</div>`});
}

function renderCerradas(){
cerradas.innerHTML="";let t=0;
operaciones.filter(o=>!o.abierta).forEach(o=>{
const r=o.cantidad*(o.precioVenta-o.precioCompra);t+=r;
cerradas.innerHTML+=`<div class="box">${o.accion}<br>${o.cantidad} × ${o.precioCompra} → ${o.precioVenta}<br><span class="${r>=0?'green':'red'}">${r.toFixed(2)} €</span></div>`;
});
totalMes.innerHTML=`TOTAL FILTRADO: ${t.toFixed(2)} €`;
}

function renderFiltroMes(){
filtroMes.innerHTML='<option value="">Todos los meses</option>';
[...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta?.slice(0,7)))]
.forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

function renderDashboard(){
let m=0,a=0;
const now=new Date(),mes=now.toISOString().slice(0,7),anio=now.getFullYear()+"";
operaciones.filter(o=>!o.abierta).forEach(o=>{
const r=o.cantidad*(o.precioVenta-o.precioCompra);
if(o.fechaVenta?.startsWith(mes)) m+=r;
if(o.fechaVenta?.startsWith(anio)) a+=r;
});
kpiMes.textContent=m.toFixed(2)+" €";
kpiAnio.textContent=a.toFixed(2)+" €";
}

function exportarCSV(){/* sin cambios */}
function backup(){const b=new Blob([JSON.stringify(operaciones)]);const a=document.createElement("a");
a.href=URL.createObjectURL(b);a.download="backup.json";a.click();}
function deshacer(){if(papelera){operaciones.push(papelera);papelera=null;guardarEstado();render();}}

render();
</script>

</body>
</html>
