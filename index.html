<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* === ESTILOS EXISTENTES (SIN CAMBIOS) === */
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;--text:#e5e7eb;
  --muted:#9ca3af;--green:#22c55e;--red:#ef4444;--accent:#3b82f6;
}
body{background:linear-gradient(180deg,#0b1220,#020617);color:var(--text);
font-family:Inter;padding:16px}
input,button,select{width:100%;padding:11px;margin:6px 0;border-radius:12px;
border:1px solid var(--border);background:#020617;color:var(--text)}
button{font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb);color:white}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);
border-radius:16px;padding:16px;margin-bottom:18px}
.box{background:#020617;border:1px solid var(--border);
border-radius:14px;padding:14px;margin-bottom:14px}
.money{font-family:monospace}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
</style>
</head>

<body>

<h2><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card">
<button class="btn-secondary" onclick="document.getElementById('csvFile').click()">
<i class="fa-solid fa-file-import"></i> Importar CSV (DEGIRO)
</button>
<input type="file" id="csvFile" accept=".csv" hidden onchange="importarCSV(this)">
</div>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card"><h3>Operaciones abiertas</h3><div id="abiertas"></div></div>
<div class="card"><h3>Operaciones cerradas</h3><div id="cerradas"></div></div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];

function guardarEstado(){localStorage.setItem("ops",JSON.stringify(operaciones))}

function guardarCompra(){
  operaciones.push({
    id:crypto.randomUUID(),
    accion:accion.value,
    cantidad:+cantidad.value,
    precioCompra:+precio.value,
    fechaCompra:fechaCompra.value,
    abierta:true
  });
  guardarEstado();render();
}

/* ================== IMPORTAR CSV ================== */
function importarCSV(input){
  const file=input.files[0];
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split("\n").slice(1);
    lines.forEach(l=>{
      const c=l.split(",");
      if(c.length<10)return;

      const accion=c[2];
      const fecha=c[0].split("-").reverse().join("-");
      const cantidad=Math.abs(Number(c[6]));
      const precio=Number(c[7].replace('"','').replace(',','.'));
      const total=Number(c[15]?.replace('"','').replace(',','.'));

      if(!accion||!cantidad||!precio||!total)return;

      const compra = total < 0;
      operaciones.push({
        id:crypto.randomUUID(),
        accion,
        cantidad,
        precioCompra: compra ? precio : precio,
        precioVenta: compra ? null : precio,
        fechaCompra: compra ? fecha : fecha,
        fechaVenta: compra ? null : fecha,
        abierta: compra
      });
    });
    guardarEstado();
    render();
  };
  reader.readAsText(file);
}
/* ================================================== */

function render(){
  abiertas.innerHTML="";
  cerradas.innerHTML="";
  operaciones.forEach(o=>{
    const box=document.createElement("div");
    box.className="box";
    if(o.abierta){
      box.innerHTML=`<strong>${o.accion}</strong><br>${o.fechaCompra}<br>
      ${o.cantidad} × ${o.precioCompra} €`;
      abiertas.appendChild(box);
    }else{
      const res=(o.cantidad*o.precioVenta)-(o.cantidad*o.precioCompra);
      box.innerHTML=`<strong>${o.accion}</strong><br>
      ${o.fechaCompra} → ${o.fechaVenta}<br>
      <span class="${res>=0?'green':'red'}">${res.toFixed(2)} €</span>`;
      cerradas.appendChild(box);
    }
  });
}

render();
</script>
</body>
</html>
