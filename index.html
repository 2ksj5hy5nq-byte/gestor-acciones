// =======================
// ESTADO GLOBAL
// =======================
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let historial = [];
let filtroTexto = "";
let filtroFechas = null;

// =======================
// UTILIDADES
// =======================
const € = n => `${n.toFixed(2)} €`;

function guardarEstado() {
  localStorage.setItem("ops", JSON.stringify(operaciones));
}

function obtenerFiltradas() {
  return operaciones.filter(o => {
    if (filtroTexto && !o.accion.toLowerCase().includes(filtroTexto))
      return false;

    if (filtroFechas && o.fechaVenta) {
      if (
        o.fechaVenta < filtroFechas.desde ||
        o.fechaVenta > filtroFechas.hasta
      ) return false;
    }
    return true;
  });
}

// =======================
// BUSCADOR
// =======================
function buscarAccion(txt) {
  filtroTexto = txt.toLowerCase();
  render();
}

// =======================
// FILTRO FECHAS
// =======================
function aplicarFiltro(desde, hasta) {
  filtroFechas = { desde, hasta };
  render();
}

// =======================
// GUARDAR COMPRA
// =======================
function guardarCompra(accion, cantidad, precio, fecha) {
  if (!accion || !cantidad || !precio || !fecha) {
    alert("Datos incompletos");
    return;
  }

  historial.push(JSON.stringify(operaciones));

  operaciones.push({
    id: crypto.randomUUID(),
    accion,
    cantidad,
    precio,
    fechaCompra: fecha,
    fechaVenta: null,
    precioVenta: null,
    abierta: true
  });

  guardarEstado();
  render();
}

// =======================
// CERRAR OPERACIÓN
// =======================
function cerrarOperacion(id, precioVenta, fechaVenta) {
  const o = operaciones.find(x => x.id === id);
  if (!o || !precioVenta || !fechaVenta) return;

  historial.push(JSON.stringify(operaciones));

  o.precioVenta = precioVenta;
  o.fechaVenta = fechaVenta;
  o.abierta = false;

  guardarEstado();
  render();
}

// =======================
// AGRUPAR CERRADAS
// =======================
function agruparPorMesYAccion() {
  const cerradas = obtenerFiltradas().filter(o => !o.abierta);
  const grupos = {};

  cerradas.forEach(o => {
    const mes = o.fechaVenta.slice(0, 7);
    if (!grupos[mes]) grupos[mes] = {};
    if (!grupos[mes][o.accion]) grupos[mes][o.accion] = [];

    grupos[mes][o.accion].push(o);
  });

  return grupos;
}

// =======================
// RENDER
// =======================
function render() {
  renderAbiertas();
  renderCerradas();
  renderResumen();
  renderAnual();
}

function renderAbiertas() {
  const c = document.getElementById("abiertas");
  c.innerHTML = "";

  obtenerFiltradas().filter(o => o.abierta).forEach(o => {
    c.innerHTML += `
      <div>
        <b>${o.accion}</b>
        ${o.cantidad} x ${o.precio} €
        <input id="pv_${o.id}" type="number" placeholder="Venta">
        <input id="fv_${o.id}" type="date">
        <button onclick="
          cerrarOperacion(
            '${o.id}',
            Number(document.getElementById('pv_${o.id}').value),
            document.getElementById('fv_${o.id}').value
          )
        ">Cerrar</button>
      </div>
    `;
  });
}

function renderCerradas() {
  const c = document.getElementById("cerradas");
  c.innerHTML = "";

  const grupos = agruparPorMesYAccion();

  Object.entries(grupos).forEach(([mes, acciones]) => {
    let totalMes = 0;
    c.innerHTML += `<h3>${mes}</h3>`;

    Object.entries(acciones).forEach(([accion, ops]) => {
      let totalAccion = 0;

      ops.forEach(o => {
        totalAccion += (o.precioVenta - o.precio) * o.cantidad;
      });

      totalMes += totalAccion;

      c.innerHTML += `
        <details>
          <summary>${accion} → ${€(totalAccion)}</summary>
          ${ops.map(o => `
            <div>
              ${o.cantidad} x ${o.precio} → ${o.precioVenta}
            </div>
          `).join("")}
        </details>
      `;
    });

    c.innerHTML += `<b>Total mes: ${€(totalMes)}</b>`;
  });
}

// =======================
// RESUMEN GENERAL
// =======================
function renderResumen() {
  let invertido = 0, recuperado = 0, abierto = 0;

  operaciones.forEach(o => {
    invertido += o.cantidad * o.precio;
    if (o.abierta) {
      abierto += o.cantidad * o.precio;
    } else {
      recuperado += o.cantidad * o.precioVenta;
    }
  });

  document.getElementById("resumen").innerHTML = `
    Capital invertido: ${€(invertido)}<br>
    Capital recuperado: ${€(recuperado)}<br>
    Capital abierto: ${€(abierto)}<br>
    Resultado: ${€(recuperado - invertido)}
  `;
}

// =======================
// RESUMEN ANUAL
// =======================
function renderAnual() {
  const r = document.getElementById("anual");
  const años = {};

  operaciones.filter(o => !o.abierta).forEach(o => {
    const a = o.fechaVenta.slice(0, 4);
    if (!años[a]) años[a] = 0;
    años[a] += (o.precioVenta - o.precio) * o.cantidad;
  });

  r.innerHTML = Object.entries(años)
    .map(([a, t]) => `${a}: ${€(t)}`)
    .join("<br>");
}

// =======================
// EXPORTAR EXCEL
// =======================
function exportarExcel() {
  const filas = [
    ["Acción", "Cantidad", "Compra", "Venta", "Fecha compra", "Fecha venta"]
  ];

  obtenerFiltradas().forEach(o => {
    filas.push([
      o.accion,
      o.cantidad,
      o.precio,
      o.precioVenta || "",
      o.fechaCompra,
      o.fechaVenta || ""
    ]);
  });

  const csv = filas.map(f => f.join(";")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "acciones.csv";
  a.click();
}

// =======================
// DESHACER
// =======================
function deshacer() {
  if (!historial.length) return;
  operaciones = JSON.parse(historial.pop());
  guardarEstado();
  render();
}

render();
