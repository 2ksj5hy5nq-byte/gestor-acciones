<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Acciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
body{
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
  padding:14px
}
h2,h3,h4{margin-top:20px}
input,button,select{
  width:100%;
  padding:8px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:6px;
  font-weight:bold
}
.green{background:#22c55e;color:black}
.gray{background:#334155;color:white}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px
}
th,td{
  border-bottom:1px solid #334155;
  padding:6px;
  text-align:center;
  font-size:14px
}
.gain{color:#22c55e}
.loss{color:#ef4444}
.box{
  background:#020617;
  padding:12px;
  border-radius:8px;
  margin-top:10px;
  text-align:center
}
.big{font-size:20px;font-weight:bold}
</style>
</head>

<body>

<h2>üìà Gestor de Acciones</h2>

<!-- NUEVA COMPRA -->
<h3>‚ûï Nueva compra</h3>
<input id="accion" placeholder="Acci√≥n">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precioCompra" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="green" onclick="guardarCompra()">Guardar compra</button>

<!-- ABIERTAS -->
<h3>üìÇ Operaciones abiertas</h3>
<table>
<thead>
<tr>
<th>Acci√≥n</th><th>Cant.</th><th>Compra</th><th>Total</th><th>Fecha</th><th>Cerrar</th>
</tr>
</thead>
<tbody id="tablaAbiertas"></tbody>
</table>

<!-- ARCHIVO ANUAL -->
<h3>üìÅ Archivo anual</h3>
<select id="anioSelect" onchange="pintarArchivo()"></select>
<div id="archivo"></div>

<script>
let abiertas = JSON.parse(localStorage.getItem("abiertas")) || [];
let archivo = JSON.parse(localStorage.getItem("archivo")) || {};

// ===== GUARDAR COMPRA =====
function guardarCompra(){
  if(!accion.value||!cantidad.value||!precioCompra.value||!fechaCompra.value){
    alert("Completa todos los campos"); return;
  }
  abiertas.push({
    accion: accion.value.toUpperCase(),
    cantidad:+cantidad.value,
    compra:+precioCompra.value,
    fechaCompra:fechaCompra.value
  });
  guardar();
  accion.value=cantidad.value=precioCompra.value=fechaCompra.value="";
  pintarAbiertas();
}

// ===== CERRAR =====
function cerrarOperacion(i){
  const pv=document.getElementById("pv_"+i).value;
  const fv=document.getElementById("fv_"+i).value;
  if(!pv||!fv){alert("Precio y fecha de venta");return;}

  const o=abiertas.splice(i,1)[0];
  o.venta=+pv;
  o.fechaVenta=fv;
  o.totalCompra=o.cantidad*o.compra;
  o.totalVenta=o.cantidad*o.venta;
  o.resultado=o.totalVenta-o.totalCompra;

  const anio=fv.slice(0,4);
  const mes=fv.slice(0,7);

  if(!archivo[anio]) archivo[anio]={};
  if(!archivo[anio][mes]) archivo[anio][mes]=[];
  archivo[anio][mes].push(o);

  guardar();
  pintarAbiertas();
  pintarSelectorAnios();
  pintarArchivo();
}

// ===== ABIERTAS =====
function pintarAbiertas(){
  tablaAbiertas.innerHTML="";
  abiertas.forEach((o,i)=>{
    tablaAbiertas.innerHTML+=`
    <tr>
      <td>${o.accion}</td>
      <td>${o.cantidad}</td>
      <td>${o.compra}</td>
      <td>${(o.cantidad*o.compra).toFixed(2)} ‚Ç¨</td>
      <td>${o.fechaCompra}</td>
      <td>
        <input id="pv_${i}" type="number" placeholder="Venta">
        <input id="fv_${i}" type="date">
        <button class="gray" onclick="cerrarOperacion(${i})">Cerrar</button>
      </td>
    </tr>`;
  });
}

// ===== SELECTOR A√ëOS =====
function pintarSelectorAnios(){
  anioSelect.innerHTML="";
  Object.keys(archivo).sort().reverse().forEach(a=>{
    anioSelect.innerHTML+=`<option value="${a}">${a}</option>`;
  });
}

// ===== ARCHIVO =====
function pintarArchivo(){
  archivoDiv.innerHTML="";
  const anio=anioSelect.value;
  if(!archivo[anio]) return;

  let totalAnual=0;

  Object.keys(archivo[anio]).sort().forEach(mes=>{
    let totalMes=0;
    let filas="";
    archivo[anio][mes].forEach(o=>{
      totalMes+=o.resultado;
      totalAnual+=o.resultado;
      filas+=`
      <tr>
        <td>${o.accion}</td>
        <td>${o.totalCompra.toFixed(2)} ‚Ç¨</td>
        <td>${o.totalVenta.toFixed(2)} ‚Ç¨</td>
        <td class="${o.resultado>=0?'gain':'loss'}">
          ${o.resultado.toFixed(2)} ‚Ç¨
        </td>
      </tr>`;
    });
    archivoDiv.innerHTML+=`
      <h4>${mes}</h4>
      <table>
        <tr>
          <th>Acci√≥n</th>
          <th>Comprado</th>
          <th>Vendido</th>
          <th>Resultado</th>
        </tr>
        ${filas}
      </table>
      <strong class="${totalMes>=0?'gain':'loss'}">
        Total mes: ${totalMes.toFixed(2)} ‚Ç¨
      </strong>`;
  });

  archivoDiv.innerHTML+=`
    <div class="box big ${totalAnual>=0?'gain':'loss'}">
      Resultado anual ${anio}: ${totalAnual.toFixed(2)} ‚Ç¨
    </div>`;
}

// ===== STORAGE =====
function guardar(){
  localStorage.setItem("abiertas",JSON.stringify(abiertas));
  localStorage.setItem("archivo",JSON.stringify(archivo));
}

const tablaAbiertas=document.getElementById("tablaAbiertas");
const archivoDiv=document.getElementById("archivo");
const anioSelect=document.getElementById("anioSelect");

pintarAbiertas();
pintarSelectorAnios();
pintarArchivo();
</script>

</body>
</html>
