<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;--text:#e5e7eb;
  --muted:#9ca3af;--green:#22c55e;--red:#ef4444;--accent:#3b82f6;
}
body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  padding:16px;
}
h2,h3{margin:0 0 10px 0}
.section-title{display:flex;align-items:center;gap:8px}
input,button,select{
  width:100%;padding:11px;margin:6px 0;border-radius:12px;
  border:1px solid var(--border);background:#020617;color:var(--text)
}
button{border:none;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb);color:white}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#022c22}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:16px;margin-bottom:18px
}
.box{
  background:#020617;border:1px solid var(--border);
  border-radius:14px;padding:14px;margin-bottom:14px
}
.money{font-variant-numeric:tabular-nums}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
.range{display:flex;gap:8px}
</style>
</head>

<body>

<h2 class="section-title"><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card">
  <h3 class="section-title"><i class="fa-solid fa-plus"></i> Nueva compra</h3>
  <input id="accion" placeholder="Acción">
  <input id="cantidad" type="number" placeholder="Cantidad">
  <input id="precio" type="number" step="0.01" placeholder="Precio compra">
  <input id="fechaCompra" type="date">
  <button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
  <h3 class="section-title"><i class="fa-solid fa-folder-open"></i> Operaciones abiertas</h3>
  <div id="abiertas"></div>
</div>

<div class="card">
  <h3 class="section-title"><i class="fa-solid fa-folder-closed"></i> Operaciones cerradas</h3>

  <select id="filtroMes" onchange="render()">
    <option value="">Todos los meses</option>
  </select>

  <div class="range">
    <input type="date" id="desde" onchange="render()">
    <input type="date" id="hasta" onchange="render()">
  </div>

  <div id="totalMes"></div>
  <div id="cerradas"></div>

  <button class="btn-secondary" onclick="deshacer()">Deshacer borrado</button>
  <button class="btn-secondary" onclick="exportarCSV()">Exportar Excel</button>
  <button class="btn-secondary" onclick="backup()">Backup</button>

  <!-- IMPORTACIÓN CSV (NUEVO, SIN BORRAR NADA) -->
  <input type="file" accept=".csv" onchange="importarCSV(this)">

  <input type="file" onchange="restaurar(this)">
</div>

<script>
let operaciones=JSON.parse(localStorage.getItem("ops"))||[];
let papelera=null,cerrarId=null;

function guardarEstado(){localStorage.setItem("ops",JSON.stringify(operaciones));}

function guardarCompra(){
  if(!accion.value||!cantidad.value||!precio.value||!fechaCompra.value)return;
  operaciones.push({
    id:crypto.randomUUID(),
    accion:accion.value.trim(),
    cantidad:Number(cantidad.value),
    precioCompra:Number(precio.value),
    fechaCompra:fechaCompra.value,
    abierta:true
  });
  guardarEstado();render();
}

function mostrarCerrar(id){cerrarId=id;render();}
function confirmarCerrar(){
  const pv=Number(document.getElementById("precioVenta").value);
  const fv=document.getElementById("fechaVenta").value;
  const o=operaciones.find(x=>x.id===cerrarId);
  o.precioVenta=pv;o.fechaVenta=fv;o.abierta=false;
  cerrarId=null;guardarEstado();render();
}

function borrar(id){
  papelera=operaciones.find(o=>o.id===id);
  operaciones=operaciones.filter(o=>o.id!==id);
  guardarEstado();render();
}
function deshacer(){if(papelera){operaciones.push(papelera);papelera=null;guardarEstado();render();}}

function render(){
  renderAbiertas();renderCerradas();renderFiltroMes();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      ${o.fechaCompra}<br>
      <span class="money">${o.cantidad} × ${o.precioCompra} €</span>
      <button class="btn-success" onclick="mostrarCerrar('${o.id}')">Cerrar</button>
      ${cerrarId===o.id?`
        <input id="precioVenta" type="number" placeholder="Precio venta">
        <input id="fechaVenta" type="date">
        <button onclick="confirmarCerrar()">Confirmar</button>`:""}
    </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";let total=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    if(filtroMes.value && !o.fechaVenta.startsWith(filtroMes.value))return;
    if(desde.value && o.fechaVenta<desde.value)return;
    if(hasta.value && o.fechaVenta>hasta.value)return;
    const r=o.cantidad*(o.precioVenta-o.precioCompra);total+=r;
    cerradas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      ${o.fechaCompra} → ${o.fechaVenta}<br>
      <span class="money">${o.cantidad} acciones</span><br>
      <span class="${r>=0?'green':'red'}">${r.toFixed(2)} €</span>
    </div>`;
  });
  totalMes.innerHTML=`<strong>TOTAL FILTRADO: ${total.toFixed(2)} €</strong>`;
}

function renderFiltroMes(){
  const meses=[...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta.slice(0,7)))];
  filtroMes.innerHTML='<option value="">Todos los meses</option>';
  meses.forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

function exportarCSV(){
  let csv="Acción,Fecha compra,Fecha venta,Cantidad,Precio compra,Precio venta,Resultado\n";
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const r=o.cantidad*(o.precioVenta-o.precioCompra);
    csv+=`${o.accion},${o.fechaCompra},${o.fechaVenta},${o.cantidad},${o.precioCompra},${o.precioVenta},${r.toFixed(2)}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="operaciones.csv";a.click();
}

function backup(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(operaciones)],{type:"application/json"}));
  a.download="backup.json";a.click();
}

function restaurar(i){
  const r=new FileReader();
  r.onload=e=>{operaciones=JSON.parse(e.target.result);guardarEstado();render();};
  r.readAsText(i.files[0]);
}

/* IMPORTACIÓN CSV DEGIRO / GENÉRICO */
function importarCSV(input){
  const r=new FileReader();
  r.onload=e=>{
    const lineas=e.target.result.split("\n").slice(1);
    const compras={};
    lineas.forEach(l=>{
      const c=l.split(",");
      if(!c[0]||!c[2]||!c[6]||!c[7])return;
      const accion=c[2].trim();
      const cantidad=Math.abs(Number(c[6]));
      const precio=Number(c[7].replace(",","."));
      const fecha=c[0].trim();
      if(Number(c[6])>0){
        compras[accion]=compras[accion]||[];
        compras[accion].push({cantidad,precio,fecha});
      }else{
        const cola=compras[accion];
        if(!cola||!cola.length)return;
        const comp=cola.shift();
        operaciones.push({
          id:crypto.randomUUID(),
          accion,
          cantidad,
          precioCompra:comp.precio,
          fechaCompra:comp.fecha,
          precioVenta:precio,
          fechaVenta:fecha,
          abierta:false
        });
      }
    });
    guardarEstado();render();
  };
  r.readAsText(input.files[0]);
}

render();
</script>

</body>
</html>
