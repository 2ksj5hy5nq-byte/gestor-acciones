<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#0b1220;--card:#111827;--border:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;
  --green:#22c55e;--red:#ef4444;
}
body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text);
  font-family:Inter,Arial;
  padding:16px;
}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
.box{background:#020617;border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
.money{font-variant-numeric:tabular-nums}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
.icon{cursor:pointer;margin-left:8px}
input,button,select{
  width:100%;padding:11px;margin:6px 0;border-radius:12px;
  border:1px solid var(--border);background:#020617;color:var(--text)
}
button{font-weight:600;cursor:pointer}
.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:12px}
</style>
</head>

<body>

<h2><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card dashboard">
  <div>
    <div>Mes en curso</div>
    <div id="kpiMes" class="money">0 €</div>
  </div>
  <div>
    <div>Año en curso</div>
    <div id="kpiAnio" class="money">0 €</div>
  </div>
</div>

<div class="card">
<h3>Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.0001" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3>Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3>Operaciones cerradas</h3>
<select id="filtroMes" onchange="render()"></select>
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">
<div id="totalMes"></div>
<div id="cerradas"></div>

<button onclick="deshacer()">Deshacer borrado</button>
<button onclick="exportarCSV()">Exportar Excel</button>
<button onclick="backup()">Backup</button>
<button onclick="csvInput.click()">Importar operaciones</button>
<input type="file" id="csvInput" hidden accept=".csv" onchange="importarCSV(this)">
<input type="file" onchange="restaurar(this)">
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];
let papelera=null;

function guardarEstado(){localStorage.setItem("ops",JSON.stringify(operaciones));}

/* CSV seguro */
function parseCSVLine(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){ q=!q; continue; }
    if(ch === "," && !q){ out.push(cur); cur=""; }
    else cur+=ch;
  }
  out.push(cur);
  return out;
}

/* decimales europeos */
function parsePrecioEU(v){
  if(!v) return 0;
  return Number(
    v.trim()
     .replace(/\s/g,"")
     .replace(/\./g,"")
     .replace(",",".")
  );
}

function guardarCompra(){
  if(!accion.value||!cantidad.value||!precio.value||!fechaCompra.value)return;
  operaciones.push({
    id:crypto.randomUUID(),
    accion:accion.value.trim(),
    cantidad:+cantidad.value,
    precioCompra:+precio.value,
    fechaCompra:fechaCompra.value,
    abierta:true
  });
  accion.value=cantidad.value=precio.value=fechaCompra.value="";
  guardarEstado();render();
}

function importarCSV(input){
  const r=new FileReader();
  r.onload=e=>{
    const filas=e.target.result.split(/\r?\n/).slice(1);
    const compras={},ventas={};

    filas.forEach(f=>{
      if(!f.trim())return;
      const c=parseCSVLine(f);

      const accion=c[2]?.trim();
      const fecha=c[0]?.split("-").reverse().join("-");
      const num=parseInt(c[6],10);
      const cantidad=Math.abs(num);
      const precio=parsePrecioEU(c[7]);

      if(!accion||!cantidad||!precio||!fecha)return;

      const obj={cantidad,precio,fecha};
      if(num<0){
        (ventas[accion]=ventas[accion]||[]).push(obj);
      }else{
        (compras[accion]=compras[accion]||[]).push(obj);
      }
    });

    Object.keys(compras).forEach(a=>{
      let v=ventas[a]||[];
      compras[a].forEach(c=>{
        if(v.length){
          const s=v.shift();
          operaciones.push({
            id:crypto.randomUUID(),
            accion:a,
            cantidad:c.cantidad,
            precioCompra:c.precio,
            fechaCompra:c.fecha,
            precioVenta:s.precio,
            fechaVenta:s.fecha,
            abierta:false
          });
        }else{
          operaciones.push({
            id:crypto.randomUUID(),
            accion:a,
            cantidad:c.cantidad,
            precioCompra:c.precio,
            fechaCompra:c.fecha,
            abierta:true
          });
        }
      });
    });
    guardarEstado();render();
  };
  r.readAsText(input.files[0]);
}

/* === NUEVO: cerrar operación abierta (manual o CSV) === */
function cerrarOperacion(id){
  const o=operaciones.find(x=>x.id===id);
  const pv=parseFloat(prompt("Precio de venta", o.precioVenta ?? ""));
  const fv=prompt("Fecha de venta (YYYY-MM-DD)", o.fechaVenta ?? "");
  if(!pv||!fv)return;
  o.precioVenta=pv;
  o.fechaVenta=fv;
  o.abierta=false;
  guardarEstado();render();
}

/* editar completa (compra y venta si existe) */
function editarOperacion(id){
  const o=operaciones.find(x=>x.id===id);

  const nc=parseFloat(prompt("Cantidad",o.cantidad));
  const pc=parseFloat(prompt("Precio compra",o.precioCompra));
  const fc=prompt("Fecha compra",o.fechaCompra);
  if(!nc||!pc||!fc)return;

  o.cantidad=nc;
  o.precioCompra=pc;
  o.fechaCompra=fc;

  if(!o.abierta){
    const pv=parseFloat(prompt("Precio venta",o.precioVenta));
    const fv=prompt("Fecha venta",o.fechaVenta);
    if(!pv||!fv)return;
    o.precioVenta=pv;
    o.fechaVenta=fv;
  }

  guardarEstado();render();
}

function borrar(id){
  papelera=operaciones.find(o=>o.id===id);
  operaciones=operaciones.filter(o=>o.id!==id);
  guardarEstado();render();
}

function deshacer(){
  if(!papelera)return;
  operaciones.push(papelera);
  papelera=null;
 
