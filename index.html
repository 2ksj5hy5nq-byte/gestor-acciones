<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestor de Acciones</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#0b1220; --card:#111827; --border:#1f2937;
  --text:#e5e7eb; --muted:#9ca3af;
  --green:#22c55e; --red:#ef4444; --accent:#3b82f6;
}
body{
  background:linear-gradient(180deg,#0b1220,#020617);
  color:var(--text); font-family:Inter,Arial; padding:16px;
}
h2,h3{margin:0 0 10px}
.section-title{display:flex;gap:8px;align-items:center}
input,button,select{
  width:100%; padding:11px; margin:6px 0;
  border-radius:12px; border:1px solid var(--border);
  background:#020617; color:var(--text);
}
button{border:none;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:#022c22}
.btn-secondary{background:#020617;border:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:18px}
.box{background:#020617;border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px}
.money{font-family:Inter,monospace}
.green{color:var(--green);font-weight:700}
.red{color:var(--red);font-weight:700}
.range{display:flex;gap:8px}
.icon{cursor:pointer;font-size:18px;padding:6px}
</style>
</head>

<body>

<h2 class="section-title"><i class="fa-solid fa-chart-line"></i> Gestor de Acciones</h2>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-plus"></i> Nueva compra</h3>
<input id="accion" placeholder="Acción">
<input id="cantidad" type="number" placeholder="Cantidad">
<input id="precio" type="number" step="0.01" placeholder="Precio compra">
<input id="fechaCompra" type="date">
<button class="btn-primary" onclick="guardarCompra()">Guardar compra</button>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-folder-open"></i> Operaciones abiertas</h3>
<div id="abiertas"></div>
</div>

<div class="card">
<h3 class="section-title"><i class="fa-solid fa-folder-closed"></i> Operaciones cerradas</h3>

<button class="btn-secondary">
  <i class="fa-solid fa-file-import"></i> Importar CSV (DEGIRO)
  <input type="file" accept=".csv" style="display:none" onchange="importarCSV(this)">
</button>

<select id="filtroMes" onchange="render()">
<option value="">Todos los meses</option>
</select>

<div class="range">
<input type="date" id="desde" onchange="render()">
<input type="date" id="hasta" onchange="render()">
</div>

<div id="totalMes"></div>
<div id="cerradas"></div>
</div>

<script>
let operaciones = JSON.parse(localStorage.getItem("ops")) || [];

function guardarEstado(){
  localStorage.setItem("ops",JSON.stringify(operaciones));
}

/* =========================
   IMPORTAR CSV DEGIRO
========================= */
function importarCSV(input){
  const file=input.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=e=>{
    const filas=e.target.result.split("\n").slice(1);
    const compras={};

    filas.forEach(f=>{
      const c=f.split(",");
      if(c.length<8) return;

      const fecha=c[0].split("-").reverse().join("-");
      const accion=c[2];
      const num=Math.abs(Number(c[6]));
      const precio=parseFloat(c[7].replace('"','').replace(",","."));
      const tipo=Number(c[6])>0?"COMPRA":"VENTA";

      if(tipo==="COMPRA"){
        if(!compras[accion]) compras[accion]=[];
        compras[accion].push({fecha,accion,num,precio,restante:num});
      }else{
        let pendiente=num;
        (compras[accion]||[]).forEach(co=>{
          if(pendiente<=0) return;
          const usar=Math.min(co.restante,pendiente);
          operaciones.push({
            id:crypto.randomUUID(),
            accion,
            cantidad:usar,
            precioCompra:co.precio,
            fechaCompra:co.fecha,
            precioVenta:precio,
            fechaVenta:fecha,
            abierta:false
          });
          co.restante-=usar;
          pendiente-=usar;
        });
      }
    });

    guardarEstado();
    render();
    alert("CSV importado correctamente");
  };
  reader.readAsText(file);
}

/* =========================
   RENDER
========================= */
function render(){
  renderAbiertas();
  renderCerradas();
  renderFiltroMes();
}

function renderAbiertas(){
  abiertas.innerHTML="";
  operaciones.filter(o=>o.abierta).forEach(o=>{
    abiertas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      ${o.fechaCompra}<br>
      <span class="money">${o.cantidad} × ${o.precioCompra} €</span>
    </div>`;
  });
}

function renderCerradas(){
  cerradas.innerHTML="";
  let total=0;
  operaciones.filter(o=>!o.abierta).forEach(o=>{
    const c=o.cantidad*o.precioCompra;
    const v=o.cantidad*o.precioVenta;
    const r=v-c; total+=r;
    cerradas.innerHTML+=`
    <div class="box">
      <strong>${o.accion}</strong><br>
      Compra ${o.fechaCompra} · ${o.cantidad} × ${o.precioCompra} € = ${c.toFixed(2)} €
      <hr>
      Venta ${o.fechaVenta} · ${o.cantidad} × ${o.precioVenta} € = ${v.toFixed(2)} €
      <div class="${r>=0?'green':'red'}">${r.toFixed(2)} €</div>
    </div>`;
  });
  totalMes.innerHTML=`<strong>TOTAL: ${total.toFixed(2)} €</strong>`;
}

function renderFiltroMes(){
  const meses=[...new Set(operaciones.filter(o=>!o.abierta).map(o=>o.fechaVenta.slice(0,7)))];
  filtroMes.innerHTML='<option value="">Todos los meses</option>';
  meses.forEach(m=>filtroMes.innerHTML+=`<option>${m}</option>`);
}

render();
</script>

</body>
</html>
