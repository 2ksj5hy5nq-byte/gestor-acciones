<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestor de Acciones</title>
<style>
body{font-family:Arial;background:#0f172a;color:white;padding:15px}
button,input,select{padding:6px;margin:4px}
button{font-weight:bold}
.nav button{margin-right:6px}
.bloque{border:1px solid #334155;border-radius:8px;padding:10px;margin-top:12px}
.abierta{opacity:.9}
.ganancia{color:#22c55e;font-weight:bold}
.perdida{color:#ef4444;font-weight:bold}
.total{font-size:18px;margin:10px 0}
.oculto{display:none}
</style>
</head>

<body>

<h2>ğŸ“ˆ Gestor de Acciones</h2>

<div class="nav">
  <button onclick="ver('abiertas')">ğŸ  Abiertas</button>
  <button onclick="ver('mes')">ğŸ“† Mes actual</button>
  <button onclick="ver('historico')">ğŸ“š HistÃ³rico</button>
</div>

<!-- ===== ABIERTAS ===== -->
<div id="abiertas">
  <h3>Operaciones abiertas</h3>

  <input id="accion" placeholder="AcciÃ³n">
  <input id="cantidad" type="number" placeholder="Cantidad">
  <input id="precioCompra" type="number" step="0.01" placeholder="Precio compra">
  <input id="fechaCompra" type="date">
  <button onclick="guardarCompra()">Guardar compra</button>

  <div id="listaAbiertas"></div>
</div>

<!-- ===== MES ACTUAL ===== -->
<div id="mes" class="oculto">
  <h3 id="tituloMes"></h3>
  <div id="totalMes" class="total"></div>
  <div id="listaMes"></div>
</div>

<!-- ===== HISTÃ“RICO ===== -->
<div id="historico" class="oculto">
  <h3>HistÃ³rico</h3>

  Desde:
  <input id="desde" type="month">
  Hasta:
  <input id="hasta" type="month">
  <button onclick="verHistorico()">Ver</button>

  <div id="listaHistorico"></div>
</div>

<script>
function guardar() {
  const accion = document.getElementById("accion").value.trim();
  const tipo = document.getElementById("tipo").value;
  const cantidad = Number(document.getElementById("cantidad").value);
  const precio = Number(document.getElementById("precio").value);
  const fecha = document.getElementById("fecha").value;

  if (!accion || !cantidad || !precio || !fecha) {
    alert("âš ï¸ Completa todos los campos");
    return;
  }

  db.collection("operaciones").add({
    uid: uid,
    accion: accion,
    tipo: tipo,
    cantidad: cantidad,
    precio: precio,
    total: cantidad * precio,
    fecha: fecha,
    creada: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert("âœ… OperaciÃ³n guardada en la nube");
  })
  .catch(err => {
    alert("âŒ Error al guardar");
    console.error(err);
  });
}
</script>

function ver(v){
  ["abiertas","mes","historico"].forEach(id=>{
    document.getElementById(id).classList.add("oculto");
  });
  document.getElementById(v).classList.remove("oculto");
  if(v==="abiertas") pintarAbiertas();
  if(v==="mes") pintarMesActual();
}

function fmt(n){
  return Number.isInteger(n) ? n+" â‚¬" : n.toFixed(2)+" â‚¬";
}

function guardarCompra(){
  if(!accion.value||!cantidad.value||!precioCompra.value||!fechaCompra.value){
    alert("Completa todos los campos"); return;
  }
  abiertas.push({
    accion:accion.value.toUpperCase(),
    cantidad:+cantidad.value,
    compra:+precioCompra.value,
    fechaCompra:fechaCompra.value
  });
  guardar();
  accion.value=cantidad.value=precioCompra.value=fechaCompra.value="";
  pintarAbiertas();
}

function cerrarOperacion(i){
  const pv = document.getElementById("pv_"+i).value;
  const fv = document.getElementById("fv_"+i).value;
  if(!pv||!fv){alert("Precio y fecha de venta");return;}

  const o = abiertas.splice(i,1)[0];
  o.venta = +pv;
  o.fechaVenta = fv;
  o.totalCompra = o.cantidad * o.compra;
  o.totalVenta = o.cantidad * o.venta;
  o.resultado = o.totalVenta - o.totalCompra;

  const clave = fv.slice(0,7);
  if(!historico[clave]) historico[clave]=[];
  historico[clave].push(o);

  guardar();
  pintarAbiertas();
}

function pintarAbiertas(){
  listaAbiertas.innerHTML="";
  abiertas.forEach((o,i)=>{
    listaAbiertas.innerHTML+=`
      <div class="bloque abierta">
        <strong>${o.accion}</strong><br>
        Compra: ${o.cantidad} Ã— ${o.compra} â‚¬<br>
        Total compra: ${fmt(o.cantidad*o.compra)}<br>
        Fecha compra: ${o.fechaCompra}<br>
        <input id="pv_${i}" type="number" step="0.01" placeholder="Precio venta">
        <input id="fv_${i}" type="date">
        <button onclick="cerrarOperacion(${i})">Cerrar</button>
      </div>`;
  });
}

function pintarMesActual(){
  const hoy = new Date().toISOString().slice(0,7);
  const ops = historico[hoy] || [];
  tituloMes.innerText = "ğŸ“† " + hoy;
  listaMes.innerHTML="";
  let total=0;
  ops.forEach(o=>{
    total+=o.resultado;
    listaMes.innerHTML+=`
      <div class="bloque">
        <strong>${o.accion}</strong><br>
        Compra: ${fmt(o.totalCompra)}<br>
        Venta: ${fmt(o.totalVenta)}<br>
        Resultado:
        <span class="${o.resultado>=0?'ganancia':'perdida'}">
          ${fmt(o.resultado)}
        </span>
      </div>`;
  });
  totalMes.innerHTML=`ğŸ’° Total mes:
    <span class="${total>=0?'ganancia':'perdida'}">${fmt(total)}</span>`;
}

function verHistorico(){
  listaHistorico.innerHTML="";
  const d = desde.value;
  const h = hasta.value;
  let total=0;
  Object.keys(historico).sort().forEach(m=>{
    if((!d||m>=d)&&(!h||m<=h)){
      let tm=0;
      listaHistorico.innerHTML+=`<h4>${m}</h4>`;
      historico[m].forEach(o=>{
        tm+=o.resultado; total+=o.resultado;
        listaHistorico.innerHTML+=`
          <div class="bloque">
            ${o.accion} â†’
            <span class="${o.resultado>=0?'ganancia':'perdida'}">
              ${fmt(o.resultado)}
            </span>
          </div>`;
      });
      listaHistorico.innerHTML+=`<strong>Total ${m}: ${fmt(tm)}</strong><br>`;
    }
  });
  listaHistorico.innerHTML+=`<h3>Total rango: ${fmt(total)}</h3>`;
}

ver("abiertas");
</script>
<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD3XGLrrvUTNHHqk8P0gU8ROeyKBapig7o",
  authDomain: "gestor-acciones.firebaseapp.com",
  projectId: "gestor-acciones",
  storageBucket: "gestor-acciones.firebasestorage.app",
  messagingSenderId: "682376422747",
  appId: "1:682376422747:web:ec250f93ad6219eb2ce67e"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Login anÃ³nimo automÃ¡tico
auth.signInAnonymously().catch(console.error);

// ConfirmaciÃ³n
auth.onAuthStateChanged(user => {
  if (user) {
    uid = user.uid;
    console.log("ğŸ”¥ Firebase conectado. UID:", user.uid);
  }
});
</script>
<!-- ============================================ -->
</body>
</html>

